<!doctype html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VFC Admin - Voice for Change</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="../../../function/shared/css/fonts.css" />
  <link rel="stylesheet" href="../../../function/admin/css/admin-base.css" />
  <script src="../../../function/admin/components/admin-nav.js"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="../../../function/shared/js/supabase-config.js"></script>

  <style>
    /* Layout */
    .admin-content {
      margin-left: 80px;
      padding: 24px 32px;
      min-height: 100vh;
    }
    @media (max-width: 1023px) {
      .admin-content {
        margin-left: 0;
        padding: 20px 16px 24px;
      }
    }

    /* Stats */
    .stat-card {
      background: white;
      border-radius: 16px;
      padding: 20px 24px;
      border: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      gap: 16px;
      transition: box-shadow 0.2s;
    }
    .stat-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.06); }
    .stat-icon {
      width: 44px; height: 44px;
      border-radius: 12px;
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0;
    }
    .stat-val { font-size: 1.5rem; font-weight: 700; color: #111827; line-height: 1; }
    .stat-lbl { font-size: 0.75rem; color: #9ca3af; margin-top: 2px; }

    /* Table card */
    .tbl-card {
      background: white;
      border-radius: 20px;
      border: 1px solid #e5e7eb;
      overflow: hidden;
    }
    .filter-card {
      background: white;
      border-radius: 16px;
      border: 1px solid #e5e7eb;
      padding: 14px 20px;
      margin-bottom: 12px;
    }
    .tbl-head {
      padding: 16px 24px;
      border-bottom: 1px solid #f3f4f6;
      display: flex; align-items: center; justify-content: space-between;
      flex-wrap: wrap; gap: 12px;
    }

    /* Filters */
    .f-select {
      padding: 7px 12px; border-radius: 10px;
      border: 1px solid #e5e7eb; font-size: 0.8125rem;
      color: #374151; background: white; outline: none;
      cursor: pointer;
    }
    .f-select:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }
    .f-search {
      padding: 7px 12px 7px 34px; border-radius: 10px;
      border: 1px solid #e5e7eb; font-size: 0.8125rem;
      outline: none; width: 200px; background: white;
    }
    .f-search:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }

    /* Table */
    .dtbl { width: 100%; border-collapse: collapse; }
    .dtbl thead th {
      padding: 10px 16px; text-align: left;
      font-size: 0.6875rem; font-weight: 600; color: #9ca3af;
      text-transform: uppercase; letter-spacing: 0.05em;
      border-bottom: 1px solid #f3f4f6; white-space: nowrap;
    }
    .dtbl tbody tr {
      border-bottom: 1px solid #f9fafb;
      transition: background 0.15s; cursor: pointer;
    }
    .dtbl tbody tr:hover { background: #f9fafb; }
    .dtbl tbody td {
      padding: 12px 16px; font-size: 0.8125rem;
      color: #374151; vertical-align: middle;
    }

    /* Badges */
    .badge {
      display: inline-flex; align-items: center; gap: 4px;
      padding: 3px 10px; border-radius: 999px;
      font-size: 0.6875rem; font-weight: 500; white-space: nowrap;
    }
    .b-complaint { background: #fef2f2; color: #dc2626; }
    .b-compliment { background: #f0fdf4; color: #16a34a; }
    .b-suggestion { background: #eff6ff; color: #2563eb; }

    .s-badge {
      display: inline-flex; align-items: center; gap: 5px;
      padding: 3px 10px; border-radius: 999px;
      font-size: 0.6875rem; font-weight: 500; white-space: nowrap;
    }
    .s-badge .dot { width: 6px; height: 6px; border-radius: 50%; }
    .s-pending { background: #fffbeb; color: #d97706; }
    .s-pending .dot { background: #f59e0b; }
    .s-in_progress { background: #eff6ff; color: #2563eb; }
    .s-in_progress .dot { background: #3b82f6; }
    .s-investigating { background: #fef3c7; color: #b45309; }
    .s-investigating .dot { background: #f97316; }
    .s-follow_up { background: #f0f9ff; color: #0369a1; }
    .s-follow_up .dot { background: #0ea5e9; }
    .s-resolved { background: #f0fdf4; color: #16a34a; }
    .s-resolved .dot { background: #22c55e; }

    /* Tracking */
    .trk { font-family: 'SF Mono','Fira Code',monospace; font-size: 0.75rem; color: #6366f1; font-weight: 500; }
    .txt-trunc { max-width: 220px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; display: block; }

    /* Unread indicator */
    .row-unread { background: #f8faff; font-weight: 500; }
    .row-unread:hover { background: #f0f4ff; }

    /* Pin */
    .row-pinned { background: #fffbeb; }
    .row-pinned:hover { background: #fef3c7; }
    .row-pinned.row-unread { background: #fef9e7; }
    .pin-icon { color: #d97706; font-size: 0.75rem; }

    /* Action btns */
    .act-btn {
      width: 28px; height: 28px; border-radius: 6px;
      border: none; background: transparent; cursor: pointer;
      display: inline-flex; align-items: center; justify-content: center;
      transition: background 0.15s; color: #9ca3af;
    }
    .act-btn:hover { background: #f3f4f6; color: #374151; }
    .act-btn.pinned { color: #d97706; }
    .act-btn svg { width: 14px; height: 14px; }

    /* Modal actions */
    .modal-actions {
      display: flex; gap: 8px; padding: 16px 24px;
      border-top: 1px solid #f3f4f6;
    }
    .m-act-btn {
      display: inline-flex; align-items: center; gap: 5px;
      padding: 7px 14px; border-radius: 8px; border: 1px solid #e5e7eb;
      font-size: 0.75rem; color: #374151; background: white;
      cursor: pointer; transition: all 0.15s;
    }
    .m-act-btn:hover { background: #f3f4f6; }
    .m-act-btn.active { background: #fffbeb; border-color: #fbbf24; color: #92400e; }
    .m-act-btn svg { width: 14px; height: 14px; }
    .unread-dot {
      width: 8px; height: 8px; border-radius: 50%;
      background: #3b82f6; display: inline-block; flex-shrink: 0;
    }
    .new-tag {
      display: inline-block; padding: 1px 6px; border-radius: 4px;
      font-size: 0.625rem; font-weight: 700; background: #ef4444; color: white;
      text-transform: uppercase; letter-spacing: 0.05em; margin-left: 6px;
      animation: pulse-new 2s infinite;
    }
    @keyframes pulse-new {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    /* Pagination */
    .pgn { display: flex; align-items: center; justify-content: space-between; padding: 14px 24px; border-top: 1px solid #f3f4f6; }
    .pgn-info { font-size: 0.8125rem; color: #6b7280; }
    .pgn-btns { display: flex; gap: 4px; }
    .pg-btn {
      padding: 5px 11px; border-radius: 8px; border: 1px solid #e5e7eb;
      font-size: 0.8125rem; color: #374151; background: white;
      cursor: pointer; transition: all 0.15s;
    }
    .pg-btn:hover { background: #f3f4f6; }
    .pg-btn.act { background: #3b82f6; color: white; border-color: #3b82f6; }
    .pg-btn:disabled { opacity: 0.35; cursor: not-allowed; }

    /* Loading / Empty */
    .msg-row td { text-align: center; padding: 48px 16px !important; color: #9ca3af; font-size: 0.875rem; }

    /* Scroll */
    .tbl-scroll { overflow-x: auto; }

    /* Refresh btn */
    .btn-ref {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 7px 16px; border-radius: 10px; border: 1px solid #e5e7eb;
      font-size: 0.8125rem; color: #374151; background: white;
      cursor: pointer; transition: all 0.15s;
    }
    .btn-ref:hover { background: #f3f4f6; }
    .btn-ref svg { width: 15px; height: 15px; }

    /* Detail modal */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.35);
      backdrop-filter: blur(4px); z-index: 100;
      display: flex; align-items: center; justify-content: center;
      padding: 16px; opacity: 0; visibility: hidden; transition: all 0.25s;
    }
    .modal-overlay.open { opacity: 1; visibility: visible; }

    /* Wrap: column layout (tab bar above + modal-box below) */
    .modal-wrap {
      display: flex; flex-direction: column;
      width: 100%; max-width: 640px;
      max-height: 88vh; height: auto;
      transform: scale(0.96); opacity: 0;
      transition: transform 0.25s cubic-bezier(0.32,0.72,0,1), opacity 0.25s;
    }
    .modal-overlay.open .modal-wrap { transform: scale(1); opacity: 1; }
    @media (min-width: 768px) {
      .modal-overlay { align-items: center; padding: 24px; }
      .modal-wrap { max-width: 100%; height: 90vh; }
    }

    /* ── Floating pill tab bar (above modal) ── */
    .m-tab-bar {
      display: flex; align-items: center;
      padding: 0 4px;
      gap: 8px; flex-shrink: 0;
      margin-bottom: 8px;
    }

    .modal-box {
      background: white; flex: 1; min-height: 0;
      border-radius: 20px; overflow: hidden;
      display: flex; flex-direction: column;
      box-shadow: 0 25px 60px rgba(0,0,0,0.18);
      scrollbar-width: none; -ms-overflow-style: none;
    }
    .modal-box::-webkit-scrollbar { display: none; }

    /* ── Modal inner layout ── */
    .m-inner { display: flex; flex-direction: column; flex: 1; overflow-y: auto; }
    @media (min-width: 768px) {
      .m-inner { flex-direction: row; overflow: hidden; }
    }

    /* Left: content */
    .m-content { padding: 24px; flex-shrink: 0; }
    @media (min-width: 768px) {
      .m-content { flex: 1; overflow-y: auto; padding: 32px; flex-shrink: 1; }
    }

    /* Right: sidebar actions */
    .m-sidebar {
      border-top: 1px solid #f3f4f6; padding: 20px 24px;
      background: #f9fafb; flex-shrink: 0;
    }
    @media (min-width: 768px) {
      .m-sidebar {
        width: 40%; flex-shrink: 0; border-top: none;
        border-left: 1px solid #f3f4f6; overflow-y: auto;
        border-radius: 0 20px 20px 0;
      }
    }

    /* ── Horizontal pill rail ── */
    .m-dot-rail {
      display: flex; flex-direction: row; gap: 6px;
      flex: 1; min-width: 0;
      overflow-x: auto; scrollbar-width: none;
    }
    .m-dot-rail::-webkit-scrollbar { display: none; }
    .m-dot {
      display: flex; align-items: center; gap: 6px;
      padding: 10px 12px 10px 16px; border-radius: 9999px;
      background: rgba(255,255,255,0.85); color: #6b7280;
      font-size: 0.82rem; font-weight: 600;
      cursor: pointer; transition: all 0.15s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border: 1px solid rgba(0,0,0,0.06);
      white-space: nowrap; flex-shrink: 0;
    }
    .m-dot:hover {
      background: rgba(255,255,255,0.95); color: #374151;
      box-shadow: 0 3px 10px rgba(0,0,0,0.12);
    }
    .m-dot.active {
      background: #3b82f6; color: white;
      border-color: #3b82f6;
      box-shadow: 0 3px 12px rgba(59,130,246,0.35);
    }
    .m-dot-label {
      max-width: 150px; min-width: 0;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .m-dot-x {
      width: 20px; height: 20px; border-radius: 50%; flex-shrink: 0;
      display: flex; align-items: center; justify-content: center;
      font-size: 11px; color: #9ca3af; cursor: pointer;
      background: transparent; border: none;
      transition: all 0.1s; opacity: 0;
    }
    .m-dot:hover .m-dot-x { opacity: 1; }
    .m-dot.active .m-dot-x { color: rgba(255,255,255,0.6); }
    .m-dot-x:hover { background: rgba(0,0,0,0.12); color: #ef4444; }

    /* ── Window controls (top-right of modal) ── */
    .m-win-ctrl {
      position: absolute; top: 12px; right: 16px;
      display: flex; gap: 8px; z-index: 10;
    }
    .m-win-btn {
      width: 36px; height: 36px; border-radius: 50%; border: none;
      cursor: pointer; transition: all 0.15s;
      display: flex; align-items: center; justify-content: center;
      font-size: 18px; color: white;
    }
    .m-win-btn:hover { transform: scale(1.1); }
    .m-win-min { background: #f59e0b; }
    .m-win-min:hover { background: #d97706; }
    .m-win-close { background: #ef4444; }
    .m-win-close:hover { background: #dc2626; }

    /* Minimized dock */
    .m-dock {
      position: fixed; left: 16px; bottom: 16px; z-index: 99;
      display: flex; flex-direction: column-reverse; gap: 8px;
    }
    @media (min-width: 768px) {
      .m-dock { left: auto; right: 16px; align-items: flex-end; }
    }
    .m-dock-item {
      display: flex; align-items: center; gap: 10px;
      padding: 6px 14px 6px 6px;
      border-radius: 9999px;
      background: rgba(255,255,255,0.92);
      backdrop-filter: blur(16px);
      border: 1px solid rgba(0,0,0,0.08);
      box-shadow: 0 4px 20px rgba(0,0,0,0.12);
      cursor: pointer; transition: all 0.2s;
      animation: dockPop 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .m-dock-item:hover { transform: translateY(-2px); box-shadow: 0 6px 24px rgba(0,0,0,0.18); }
    .m-dock-icon {
      width: 36px; height: 36px; border-radius: 50%; flex-shrink: 0;
      display: flex; align-items: center; justify-content: center;
      color: white; font-weight: 700; font-size: 0.8rem;
    }
    .m-dock-label {
      font-size: 0.78rem; font-weight: 600; color: #374151;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
      max-width: 140px;
    }
    @keyframes dockPop {
      from { transform: scale(0); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    /* Top meta bar */
    .m-meta {
      display: flex; align-items: center; gap: 8px; flex-wrap: wrap;
      padding-bottom: 16px; margin-bottom: 20px;
      border-bottom: 1px solid #f3f4f6;
      font-size: 0.75rem; color: #9ca3af;
    }

    /* Subject */
    .m-subject {
      font-size: 1.5rem; font-weight: 800; color: #111827;
      line-height: 1.35; margin-bottom: 20px; letter-spacing: -0.01em;
    }

    /* Sender row */
    .m-sender-card {
      display: flex; align-items: center; gap: 14px;
      padding-bottom: 20px; margin-bottom: 20px;
      border-bottom: 1px solid #f3f4f6;
    }
    .m-avatar {
      width: 44px; height: 44px; border-radius: 50%;
      background: linear-gradient(135deg, #818cf8, #6366f1);
      display: flex; align-items: center; justify-content: center;
      color: white; font-weight: 700; font-size: 1rem; flex-shrink: 0;
      box-shadow: 0 2px 8px rgba(99,102,241,0.25);
    }
    .m-sender-name { font-size: 0.9375rem; font-weight: 600; color: #111827; }
    .m-sender-sub { font-size: 0.75rem; color: #9ca3af; margin-top: 2px; }

    /* Section label */
    .m-label {
      font-size: 0.6875rem; font-weight: 600; color: #9ca3af;
      text-transform: uppercase; letter-spacing: 0.06em;
      margin-bottom: 8px;
    }

    /* Body text */
    .m-body {
      font-size: 0.9375rem; color: #374151; line-height: 1.85;
      white-space: pre-wrap; word-break: break-word;
      margin-bottom: 20px;
    }

    /* Fix text callout */
    .m-fix {
      display: flex; gap: 10px; align-items: flex-start;
      padding: 14px 16px; background: #fffbeb; border-radius: 14px;
      font-size: 0.8125rem; color: #92400e; margin-bottom: 20px;
      border: 1px solid #fde68a;
    }
    .m-fix-icon {
      width: 20px; height: 20px; flex-shrink: 0; margin-top: 1px;
    }

    /* Info table */
    .m-info-table {
      width: 100%; border-radius: 14px; overflow: hidden;
      border: 1px solid #f3f4f6; margin-bottom: 8px;
    }
    .m-info-row-item {
      display: flex; border-bottom: 1px solid #f3f4f6;
    }
    .m-info-row-item:last-child { border-bottom: none; }
    .m-info-label {
      width: 100px; flex-shrink: 0; padding: 10px 14px;
      font-size: 0.6875rem; font-weight: 600; color: #9ca3af;
      text-transform: uppercase; letter-spacing: 0.04em;
      background: #fafafa;
    }
    .m-info-val {
      flex: 1; padding: 10px 14px;
      font-size: 0.8125rem; color: #111827; font-weight: 500;
    }

    /* Sidebar section */
    .m-sb-section { margin-bottom: 20px; }
    .m-sb-section:last-child { margin-bottom: 0; }
    .m-sb-label {
      font-size: 0.6875rem; font-weight: 600; color: #9ca3af;
      text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 8px;
    }

    /* Status pills */
    .m-status-pills { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 8px; }
    .m-s-pill {
      padding: 6px 14px; border-radius: 999px; border: 1.5px solid #e5e7eb;
      font-size: 0.75rem; font-weight: 500; cursor: pointer;
      background: white; color: #6b7280; transition: all 0.15s;
    }
    .m-s-pill:hover { border-color: #3b82f6; color: #3b82f6; }
    .m-s-pill.active { background: #3b82f6; border-color: #3b82f6; color: white; }

    /* Sidebar button */
    .m-sb-btn {
      width: 100%; padding: 10px; border-radius: 12px; border: none;
      font-size: 0.8125rem; font-weight: 600; cursor: pointer;
      transition: all 0.15s; background: #3b82f6; color: white;
    }
    .m-sb-btn:hover { background: #2563eb; }
    .m-sb-btn.outline {
      background: white; color: #374151; border: 1.5px solid #e5e7eb;
    }
    .m-sb-btn.outline:hover { border-color: #3b82f6; color: #3b82f6; }

    /* Sidebar textarea */
    .m-sb-textarea {
      width: 100%; padding: 10px 12px; border-radius: 12px;
      border: 1.5px solid #e5e7eb; font-size: 0.8125rem;
      color: #374151; outline: none; resize: vertical; min-height: 80px;
      font-family: inherit; line-height: 1.6; background: white;
      margin-bottom: 8px;
    }
    .m-sb-textarea:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }

    .m-sb-msg { font-size: 0.75rem; margin-top: 6px; min-height: 18px; }

    /* Action bar (bottom of sidebar) */
    .m-sb-actions { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e7eb; }
    .m-act-btn2 {
      display: inline-flex; align-items: center; gap: 4px;
      padding: 6px 12px; border-radius: 10px; border: 1.5px solid #e5e7eb;
      font-size: 0.75rem; cursor: pointer; background: white; color: #6b7280;
      transition: all 0.15s;
    }
    .m-act-btn2:hover { border-color: #3b82f6; color: #3b82f6; }
    .m-act-btn2 svg { width: 14px; height: 14px; }

    /* Tab bar — underline style */
    .tab-bar {
      display: flex; align-items: center; gap: 0;
      border-bottom: 2px solid #e5e7eb;
      width: 100%; margin-bottom: 20px;
    }
    .tab-btn {
      padding: 10px 20px; border: none; border-bottom: 2px solid transparent;
      margin-bottom: -2px; font-size: 0.8125rem; font-weight: 500;
      cursor: pointer; transition: all 0.15s;
      background: transparent; color: #6b7280; white-space: nowrap;
      display: flex; align-items: center; gap: 6px;
    }
    .tab-btn:hover { color: #111827; }
    .tab-btn.active { color: #2563eb; border-bottom-color: #2563eb; font-weight: 600; }
    .tab-btn.active:hover { color: #1d4ed8; border-bottom-color: #1d4ed8; }

    /* Floating pill header */
    .floating-header {
      position: fixed; top: 10px; left: 50%; transform: translateX(-50%) translateY(-20px);
      z-index: 55; opacity: 0; visibility: hidden; pointer-events: none;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      background: rgba(255,255,255,0.82); backdrop-filter: saturate(180%) blur(20px);
      -webkit-backdrop-filter: saturate(180%) blur(20px);
      border-radius: 999px; padding: 8px 24px;
      box-shadow: 0 2px 20px rgba(0,0,0,0.08); border: 1px solid rgba(0,0,0,0.06);
      display: flex; align-items: center; gap: 8px;
    }
    .floating-header.visible {
      opacity: 1; visibility: visible; pointer-events: auto;
      transform: translateX(-50%) translateY(0);
    }
    .floating-header h1 { font-size: 0.875rem; font-weight: 700; color: #111827; margin: 0; white-space: nowrap; }
    .floating-header p { font-size: 0.625rem; color: #9ca3af; margin: 0; white-space: nowrap; display: none; }
    @media (min-width: 640px) {
      .floating-header p { display: block; }
      .floating-header::before {
        content: ''; width: 1px; height: 16px; background: rgba(0,0,0,0.1);
      }
    }

    /* Mobile: text tabs from left */
    @media (max-width: 640px) {
      .tab-bar { justify-content: flex-start; }
      .tab-btn { padding: 10px 14px; font-size: 0.75rem; }
      .tab-btn svg { display: none; }
    }
    .tab-placeholder {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      min-height: 400px; color: #9ca3af; gap: 12px;
    }
    .tab-placeholder svg { width: 48px; height: 48px; opacity: 0.4; }
    .tab-placeholder p { font-size: 0.875rem; }

    /* Kanban Board */
    .kanban-wrap {
      display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px;
      min-height: calc(100vh - 200px); align-items: start;
    }
    @media (max-width: 1024px) {
      .kanban-wrap { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 640px) {
      .kanban-wrap { grid-template-columns: 1fr; }
    }
    .kanban-col {
      background: #f4f5f7; border-radius: 12px;
      display: flex; flex-direction: column;
      max-height: calc(100vh - 200px);
    }
    .kanban-col-head {
      padding: 12px 16px; font-size: 0.75rem; font-weight: 700;
      text-transform: uppercase; letter-spacing: 0.05em;
      color: #5e6c84; display: flex; align-items: center; gap: 8px;
      border-bottom: 2px solid transparent; flex-shrink: 0;
    }
    .kanban-col-head .col-count {
      background: #dfe1e6; color: #44546f; border-radius: 10px;
      padding: 0 7px; font-size: 0.6875rem; font-weight: 600; min-width: 20px;
      text-align: center; line-height: 20px;
    }
    .kanban-col[data-status="pending"] .kanban-col-head { border-bottom-color: #f59e0b; }
    .kanban-col[data-status="in_progress"] .kanban-col-head { border-bottom-color: #3b82f6; }
    .kanban-col[data-status="investigating"] .kanban-col-head { border-bottom-color: #f97316; }
    .kanban-col[data-status="follow_up"] .kanban-col-head { border-bottom-color: #0ea5e9; }
    .kanban-col[data-status="resolved"] .kanban-col-head { border-bottom-color: #22c55e; }
    .kanban-cards {
      padding: 8px; overflow-y: auto; flex: 1;
      display: flex; flex-direction: column; gap: 8px;
    }
    .kanban-cards::-webkit-scrollbar { width: 4px; }
    .kanban-cards::-webkit-scrollbar-thumb { background: #c1c7d0; border-radius: 4px; }
    .kanban-card {
      background: white; border-radius: 8px; padding: 12px;
      border: 1px solid #dfe1e6; cursor: pointer;
      transition: box-shadow 0.15s, border-color 0.15s;
    }
    .kanban-card:hover {
      box-shadow: 0 1px 5px rgba(9,30,66,0.15);
      border-color: #c1c7d0;
    }
    .kanban-card-title {
      font-size: 0.8125rem; font-weight: 500; color: #172b4d;
      margin-bottom: 8px; line-height: 1.4;
      display: -webkit-box; -webkit-line-clamp: 2;
      -webkit-box-orient: vertical; overflow: hidden;
    }
    .kanban-card-cat {
      display: inline-block; padding: 1px 6px; border-radius: 4px;
      font-size: 0.625rem; font-weight: 700;
      margin-bottom: 8px;
    }
    .kanban-card-footer {
      display: flex; align-items: center; justify-content: space-between;
      font-size: 0.6875rem; color: #5e6c84;
    }
    .kanban-card-trk {
      font-family: 'SF Mono','Fira Code',monospace;
      font-size: 0.6875rem; color: #6366f1;
    }
    .kanban-card-date { color: #97a0af; font-size: 0.625rem; }
    .kanban-empty {
      text-align: center; padding: 24px 12px;
      color: #b3bac5; font-size: 0.75rem;
    }

    /* ====== Power BI Dashboard ====== */
    .dash-grid {
      display: grid; grid-template-columns: 1fr 1fr; gap: 16px;
    }
    @media (max-width: 768px) { .dash-grid { grid-template-columns: 1fr; } }
    .dash-card {
      background: white; border: 1px solid #e5e7eb; border-radius: 14px;
      padding: 20px; overflow: hidden;
    }
    .dash-card-full { grid-column: 1 / -1; }
    .dash-card-head {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 16px;
    }
    .dash-card-title {
      font-size: 0.875rem; font-weight: 600; color: #111827;
    }
    .dash-card-sub {
      font-size: 0.6875rem; color: #9ca3af; margin-top: 2px;
    }
    /* Type filter pills */
    .dash-filter-bar {
      display: flex; align-items: center; gap: 6px; flex-wrap: wrap; margin-bottom: 16px;
    }
    .dash-filter-pill {
      padding: 5px 14px; border-radius: 20px; border: 1.5px solid #e5e7eb;
      font-size: 0.75rem; font-weight: 500; cursor: pointer;
      transition: all 0.2s; background: white; color: #6b7280;
    }
    .dash-filter-pill:hover { border-color: #c7d2fe; background: #f5f3ff; }
    .dash-filter-pill.active {
      background: #4f46e5; color: white; border-color: #4f46e5;
    }
    /* Donut */
    .donut-wrap {
      display: flex; align-items: center; gap: 24px;
    }
    @media (max-width: 480px) { .donut-wrap { flex-direction: column; } }
    .donut-svg { flex-shrink: 0; }
    .donut-svg circle {
      transition: stroke-dasharray 0.6s ease, stroke-dashoffset 0.6s ease;
    }
    .donut-center {
      font-size: 1.5rem; font-weight: 700; fill: #111827;
    }
    .donut-center-lbl {
      font-size: 0.625rem; fill: #9ca3af;
    }
    .donut-legend { display: flex; flex-direction: column; gap: 8px; min-width: 130px; }
    .donut-legend-item {
      display: flex; align-items: center; gap: 8px;
      font-size: 0.8125rem; color: #374151; cursor: pointer;
    }
    .donut-legend-item:hover { color: #111827; }
    .donut-dot {
      width: 12px; height: 12px; border-radius: 3px; flex-shrink: 0;
    }
    .donut-legend-val {
      margin-left: auto; font-weight: 600; color: #111827;
    }
    /* MoM / YoY cards */
    .mom-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 480px) { .mom-grid { grid-template-columns: 1fr; } }
    .mom-card {
      background: #f9fafb; border-radius: 10px; padding: 14px 16px;
      display: flex; flex-direction: column; gap: 4px;
    }
    .mom-label { font-size: 0.6875rem; color: #6b7280; font-weight: 500; }
    .mom-row { display: flex; align-items: baseline; gap: 8px; }
    .mom-val { font-size: 1.5rem; font-weight: 700; color: #111827; }
    .mom-badge {
      display: inline-flex; align-items: center; gap: 3px;
      font-size: 0.6875rem; font-weight: 600;
      padding: 2px 8px; border-radius: 12px;
    }
    .mom-up { background: #dcfce7; color: #16a34a; }
    .mom-down { background: #fee2e2; color: #dc2626; }
    .mom-flat { background: #f3f4f6; color: #6b7280; }
    .mom-desc { font-size: 0.625rem; color: #9ca3af; }
    /* Bar chart */
    .bar-chart-wrap {
      display: flex; align-items: flex-end; gap: 6px; height: 160px;
      padding: 8px 0;
    }
    .bar-col {
      flex: 1; display: flex; flex-direction: column; align-items: center;
      gap: 4px; height: 100%; justify-content: flex-end;
    }
    .bar-fill {
      width: 100%; max-width: 56px; border-radius: 5px 5px 0 0;
      transition: height 0.5s ease; position: relative;
      cursor: pointer;
    }
    .bar-fill:hover { opacity: 0.85; }
    .bar-val {
      font-size: 0.625rem; font-weight: 600; color: #374151;
    }
    .bar-lbl {
      font-size: 0.6875rem; color: #6b7280; white-space: nowrap;
    }

    /* Horizontal bars */
    .hbar-row {
      display: flex; align-items: center; gap: 10px; margin-bottom: 10px;
    }
    .hbar-label {
      font-size: 0.75rem; color: #374151; min-width: 80px; font-weight: 500;
    }
    .hbar-track {
      flex: 1; height: 14px; background: #f3f4f6; border-radius: 7px;
      overflow: hidden;
    }
    .hbar-fill {
      height: 100%; border-radius: 7px; transition: width 0.5s ease;
    }
    .hbar-val {
      font-size: 0.75rem; font-weight: 600; color: #111827; min-width: 30px;
      text-align: right;
    }
    .hbar-pct {
      font-size: 0.625rem; color: #9ca3af; min-width: 35px; text-align: right;
    }
    /* Progress */
    .prog-bar {
      height: 14px; border-radius: 7px; background: #f3f4f6;
      overflow: hidden; display: flex; margin-bottom: 12px;
    }
    .prog-fill { height: 100%; transition: width 0.5s ease; }
    .prog-stats {
      display: flex; gap: 20px;
    }
    .prog-item { display: flex; flex-direction: column; }
    .prog-item .pval { font-size: 1.25rem; font-weight: 700; }
    .prog-item .plbl { font-size: 0.625rem; color: #9ca3af; }
  </style>
</head>
<body class="bg-white min-h-screen">
  <!-- Admin Navigation -->
  <div id="adminNavContainer" data-admin-nav="vfc"></div>

  <!-- Main Content -->
  <div class="admin-content">

    <!-- Header -->
    <div class="mb-4" id="pageHeader">
      <h1 class="text-xl font-bold text-gray-900">Voice for Change</h1>
      <p class="text-sm text-gray-500 mt-0.5">จัดการคำร้องเรียน ชมเชย และข้อเสนอแนะ</p>
    </div>

    <!-- Floating pill header (shows on scroll) -->
    <div class="floating-header" id="floatingHeader">
      <h1>Voice for Change</h1>
      <p>จัดการคำร้องเรียน ชมเชย และข้อเสนอแนะ</p>
    </div>



    <!-- Tab Bar -->
    <div class="tab-bar" style="margin-bottom:16px">
      <button class="tab-btn active" id="tabInbox" onclick="switchTab('inbox')">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-4 0a1 1 0 01-1-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 01-1 1"/></svg>
        หน้าแรก
      </button>
      <button class="tab-btn" id="tabBoard" onclick="switchTab('board')">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2"/></svg>
        กระดาน
      </button>
      <button class="tab-btn" id="tabTable" onclick="switchTab('table')">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/></svg>
        รายการ
      </button>
      <button class="tab-btn" id="tabCalendar" onclick="switchTab('calendar')">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
        ปฏิทิน
      </button>
      <button class="tab-btn" id="tabTrash" onclick="switchTab('trash')">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
        ถังขยะ <span id="trashCount" style="background:#ef4444;color:white;border-radius:9999px;padding:1px 6px;font-size:0.65rem;margin-left:2px;display:none">0</span>
      </button>
      <button class="tab-btn" id="tabSettings" onclick="switchTab('settings')">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
        ตั้งค่า
      </button>
    </div>

    <!-- Tab: Inbox -->
    <div id="contentInbox" class="tab-content">

    <!-- Stats -->
    <div class="grid grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4 mb-6">
      <div class="stat-card">
        <div class="stat-icon bg-indigo-50">
          <svg class="w-5 h-5 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
        </div>
        <div><div class="stat-val" id="sTotal">-</div><div class="stat-lbl">ทั้งหมด</div></div>
      </div>
      <div class="stat-card">
        <div class="stat-icon bg-amber-50">
          <svg class="w-5 h-5 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        </div>
        <div><div class="stat-val" id="sPending">-</div><div class="stat-lbl">รอดำเนินการ</div></div>
      </div>
      <div class="stat-card">
        <div class="stat-icon bg-blue-50">
          <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
        </div>
        <div><div class="stat-val" id="sProgress">-</div><div class="stat-lbl">กำลังดำเนินการ</div></div>
      </div>
      <div class="stat-card">
        <div class="stat-icon" style="background:#fef3c7">
          <svg class="w-5 h-5" style="color:#f97316" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
        </div>
        <div><div class="stat-val" id="sInvestigating">-</div><div class="stat-lbl">กำลังตรวจสอบ</div></div>
      </div>
      <div class="stat-card">
        <div class="stat-icon" style="background:#f0f9ff">
          <svg class="w-5 h-5" style="color:#0ea5e9" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg>
        </div>
        <div><div class="stat-val" id="sFollowUp">-</div><div class="stat-lbl">ติดตามผล</div></div>
      </div>
      <div class="stat-card">
        <div class="stat-icon bg-green-50">
          <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        </div>
        <div><div class="stat-val" id="sResolved">-</div><div class="stat-lbl">เสร็จสิ้น</div></div>
      </div>
    </div>

    <!-- Dashboard: Interactive Charts -->
    <div id="dashCharts"></div>

    </div>

    <!-- Tab: Kanban Board -->
    <div id="contentBoard" class="tab-content hidden">
      <div class="kanban-wrap" id="kanbanBoard"></div>
    </div>



    <!-- Tab: Trash -->
    <div id="contentTrash" class="tab-content hidden">
      <div style="padding:24px">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
          <h3 style="font-size:1.1rem;font-weight:700;color:#111827;display:flex;align-items:center;gap:8px">
            <svg style="width:20px;height:20px" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
            ถังขยะ
          </h3>
          <button onclick="emptyTrash()" style="background:#ef4444;color:white;border:none;border-radius:10px;padding:8px 16px;font-size:0.8rem;font-weight:600;cursor:pointer">ล้างถังขยะ</button>
        </div>
        <div id="trashList"></div>
      </div>
    </div>

    <!-- Tab: Settings -->
    <div id="contentSettings" class="tab-content hidden">
      <div class="tab-placeholder">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
        <p>ตั้งค่า — Settings</p>
      </div>
    </div>

    <!-- Tab: Calendar -->
    <div id="contentCalendar" class="tab-content hidden">
      <div id="calendarView" style="padding:24px">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px">
          <button onclick="changeCalMonth(-1)" style="background:none;border:1px solid #e5e7eb;border-radius:10px;padding:8px 14px;cursor:pointer;font-size:0.85rem;color:#374151">◀ เดือนก่อน</button>
          <h3 id="calMonthLabel" style="font-size:1.1rem;font-weight:700;color:#111827"></h3>
          <button onclick="changeCalMonth(1)" style="background:none;border:1px solid #e5e7eb;border-radius:10px;padding:8px 14px;cursor:pointer;font-size:0.85rem;color:#374151">เดือนถัดไป ▶</button>
        </div>
        <div id="calGrid" style="display:grid;grid-template-columns:repeat(7,1fr);gap:4px"></div>
      </div>
    </div>

    <!-- Tab: Table -->
    <div id="contentTable" class="tab-content hidden">
    <!-- Filter Card -->
    <div class="filter-card">
      <div class="flex items-center justify-between flex-wrap gap-3">
        <div class="flex items-center gap-2 flex-wrap">
          <select id="fType" onchange="applyFilters()" class="f-select">
            <option value="">ทุกประเภท</option>
            <option value="complaint">ร้องเรียน</option>
            <option value="compliment">ชมเชย</option>
            <option value="suggestion">เสนอแนะ</option>
          </select>
          <select id="fStatus" onchange="applyFilters()" class="f-select">
            <option value="">ทุกสถานะ</option>
            <option value="pending">รอดำเนินการ</option>
            <option value="in_progress">กำลังดำเนินการ</option>
            <option value="investigating">กำลังตรวจสอบ</option>
            <option value="follow_up">ติดตามผล</option>
            <option value="resolved">เสร็จสิ้น</option>
          </select>
          <div class="flex items-center gap-1.5">
            <input type="date" id="fDateFrom" onchange="applyFilters()" class="f-select" title="ตั้งแต่วันที่">
            <span class="text-gray-400 text-xs">ถึง</span>
            <input type="date" id="fDateTo" onchange="applyFilters()" class="f-select" title="ถึงวันที่">
          </div>
          <select id="fRead" onchange="applyFilters()" class="f-select">
            <option value="">ทั้งหมด</option>
            <option value="unread">ยังไม่ได้อ่าน</option>
            <option value="read">อ่านแล้ว</option>
            <option value="pinned">ปักมุด</option>
          </select>
        </div>
        <div class="relative">
          <svg class="w-4 h-4 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
          <input type="text" id="fSearch" placeholder="ค้นหา..." class="f-search" oninput="applyFilters()">
        </div>
      </div>
    </div>

    <!-- Table Card -->
    <div class="tbl-card">

      <!-- Table -->
      <div class="tbl-scroll">
        <table class="dtbl">
          <thead>
            <tr>
              <th style="width:36px"></th>
              <th>หมายเลขหนังสือ</th>
              <th>เลขติดตาม</th>
              <th>ประเภท</th>
              <th>หัวข้อ</th>
              <th>หมวดหมู่</th>
              <th>สถานี</th>
              <th>ฝ่าย</th>
              <th>สถานะ</th>
              <th>วันที่</th>
              <th style="width:40px"></th>
            </tr>
          </thead>
          <tbody id="tBody">
            <tr class="msg-row"><td colspan="11">กำลังโหลดข้อมูล...</td></tr>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="pgn">
        <div class="pgn-info" id="pInfo">-</div>
        <div class="pgn-btns" id="pBtns"></div>
      </div>
    </div>
    </div><!-- /contentTable -->

  </div><!-- /admin-content -->
  <!-- Detail Modal -->
  <div id="detailModal" class="modal-overlay" onclick="if(event.target===this)minimizeActiveTab()">
    <div class="modal-wrap">
      <!-- Floating pill tab bar (above modal) -->
      <div class="m-tab-bar">
        <div class="m-dot-rail" id="mDotRail"></div>
      </div>
      <!-- Modal box -->
      <div class="modal-box" style="position:relative">
        <!-- Window controls top-right -->
        <div class="m-win-ctrl">
          <button onclick="minimizeAllTabs()" class="m-win-btn m-win-min" title="ย่อทั้งหมด">−</button>
          <button onclick="closeAllTabs()" class="m-win-btn m-win-close" title="ปิดทั้งหมด">✕</button>
        </div>
        <div class="m-inner">
          <div class="m-content" id="mContent"></div>
          <div class="m-sidebar" id="mSidebar"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Minimized dock -->
  <div class="m-dock" id="mDock"></div>

  <script>
    // ========================================
    // Floating pill header on scroll
    // ========================================
    (function() {
      const header = document.getElementById('pageHeader');
      const pill = document.getElementById('floatingHeader');
      if (header && pill) {
        const obs = new IntersectionObserver(([e]) => {
          pill.classList.toggle('visible', !e.isIntersecting);
        }, { threshold: 0 });
        obs.observe(header);
      }
    })();

    // ========================================
    // VFC Admin — Supabase Data Table
    // ========================================
    let allData = [], filtered = [], page = 1;
    let trashData = JSON.parse(localStorage.getItem('vfc_trash') || '[]');
    const PER = 20;

    // Category EN → TH mapping
    const CATEGORIES = {
      // Complaint
      work_environment: 'สภาพแวดล้อมในการทำงาน',
      management: 'การบริหารจัดการ',
      hr_welfare: 'สวัสดิการและทรัพยากรบุคคล',
      equipment: 'อุปกรณ์และเครื่องมือ',
      safety: 'ความปลอดภัย',
      communication: 'การสื่อสารภายในองค์กร',
      process: 'กระบวนการทำงาน',
      colleague: 'เพื่อนร่วมงาน',
      supervisor: 'หัวหน้างาน',
      // Compliment
      service: 'การบริการ',
      teamwork: 'การทำงานเป็นทีม',
      leadership: 'ภาวะผู้นำ',
      problem_solving: 'การแก้ปัญหา',
      dedication: 'ความทุ่มเท',
      helping: 'การช่วยเหลือ',
      // Suggestion
      facility: 'สิ่งอำนวยความสะดวก',
      welfare: 'สวัสดิการ',
      policy: 'นโยบาย',
      technology: 'เทคโนโลยี',
      training: 'การฝึกอบรม',
      // Common
      other: 'อื่นๆ'
    };
    function catTh(key) { return CATEGORIES[key] || key || '-'; }

    // Tab switching
    function switchTab(tabName) {
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelectorAll('.tab-content').forEach(c => {
        c.classList.add('hidden');
      });
      const btnId = 'tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1);
      const contentId = 'content' + tabName.charAt(0).toUpperCase() + tabName.slice(1);
      document.getElementById(btnId).classList.add('active');
      document.getElementById(contentId).classList.remove('hidden');
      if (tabName === 'board') renderBoard();
      if (tabName === 'inbox') renderDashboard();
      if (tabName === 'calendar') renderCalendar();
      if (tabName === 'trash') renderTrash();
    }

    // Dashboard — Power BI style
    let dashTypeFilter = '';
    let dashYear = new Date().getFullYear();
    let dashMonth = '';
    let dashFilterYear = '';
    let dashDept = '';
    function setDashFilter(type) {
      dashTypeFilter = type;
      renderDashboard();
    }
    function setDashYear(y) {
      dashYear = parseInt(y);
      renderDashboard();
    }
    function setDashMonth(m) {
      dashMonth = m;
      renderDashboard();
    }
    function setDashFilterYear(y) {
      dashFilterYear = y;
      renderDashboard();
    }
    function setDashDept(d) {
      dashDept = d;
      renderDashboard();
    }
    function renderDashboard() {
      // Apply all dashboard filters
      let src = [...allData];
      if (dashTypeFilter) src = src.filter(d => d.type === dashTypeFilter);
      if (dashFilterYear) src = src.filter(d => d.created_at && new Date(d.created_at).getFullYear() === parseInt(dashFilterYear));
      if (dashMonth) src = src.filter(d => d.created_at && (new Date(d.created_at).getMonth() + 1) === parseInt(dashMonth));
      if (dashDept) src = src.filter(d => (d.detail_department || '') === dashDept);
      const total = src.length;
      const allTotal = allData.length;
      const container = document.getElementById('dashCharts');
      if (!allTotal) { container.innerHTML = ''; return; }

      // Available years from data
      const yearsSet = new Set();
      allData.forEach(r => { if (r.created_at) yearsSet.add(new Date(r.created_at).getFullYear()); });
      yearsSet.add(new Date().getFullYear());
      const availYears = [...yearsSet].sort((a,b) => b - a);

      // Available departments from data
      const deptSet = new Set();
      allData.forEach(r => { if (r.detail_department) deptSet.add(r.detail_department); });
      const availDepts = [...deptSet].sort();

      // Counts by type (from filtered src)
      const cComplaint = src.filter(d => d.type === 'complaint').length;
      const cSuggestion = src.filter(d => d.type === 'suggestion').length;
      const cCompliment = src.filter(d => d.type === 'compliment').length;

      // Status counts
      const pending = src.filter(d => !d.status || d.status === 'pending').length;
      const inProg = src.filter(d => d.status === 'in_progress').length;
      const resolved = src.filter(d => d.status === 'resolved').length;
      const closed = src.filter(d => d.status === 'closed').length;
      const done = resolved + closed;

      // MoM / YoY
      const now = new Date();
      const getMonthKey = (y, m) => y + '-' + String(m+1).padStart(2,'0');
      const curMonthKey = getMonthKey(now.getFullYear(), now.getMonth());
      const prevMonth = new Date(now.getFullYear(), now.getMonth()-1, 1);
      const prevMonthKey = getMonthKey(prevMonth.getFullYear(), prevMonth.getMonth());
      const sameMonthLastYear = new Date(now.getFullYear()-1, now.getMonth(), 1);
      const yoyKey = getMonthKey(sameMonthLastYear.getFullYear(), sameMonthLastYear.getMonth());

      const countByKey = (key) => src.filter(r => r.created_at && r.created_at.startsWith(key)).length;
      const curCount = countByKey(curMonthKey);
      const prevCount = countByKey(prevMonthKey);
      const yoyCount = countByKey(yoyKey);

      const momPct = prevCount ? Math.round((curCount - prevCount) / prevCount * 100) : (curCount ? 100 : 0);
      const yoyPct = yoyCount ? Math.round((curCount - yoyCount) / yoyCount * 100) : (curCount ? 100 : 0);

      const badge = (pct) => {
        if (pct > 0) return `<span class="mom-badge mom-up">▲ +${pct}%</span>`;
        if (pct < 0) return `<span class="mom-badge mom-down">▼ ${pct}%</span>`;
        return `<span class="mom-badge mom-flat">— 0%</span>`;
      };

      // Monthly Jan-Dec for selected year
      const monthFull = ['มกราคม','กุมภาพันธ์','มีนาคม','เมษายน','พฤษภาคม','มิถุนายน','กรกฎาคม','สิงหาคม','กันยายน','ตุลาคม','พฤศจิกายน','ธันวาคม'];
      const monthShort = ['ม.ค.','ก.พ.','มี.ค.','เม.ย.','พ.ค.','มิ.ย.','ก.ค.','ส.ค.','ก.ย.','ต.ค.','พ.ย.','ธ.ค.'];
      const isWide = window.innerWidth >= 768;
      const months = [];
      for (let m = 0; m < 12; m++) {
        const key = dashYear + '-' + String(m+1).padStart(2,'0');
        const count = src.filter(r => r.created_at && r.created_at.startsWith(key)).length;
        months.push({ label: isWide ? monthFull[m] : monthShort[m], count, key });
      }
      const maxMonth = Math.max(...months.map(m => m.count), 1);

      // Donut
      const donutData = [
        { label: 'รอดำเนินการ', val: pending, color: '#f59e0b' },
        { label: 'กำลังดำเนินการ', val: inProg, color: '#3b82f6' },
        { label: 'เสร็จสิ้น', val: resolved, color: '#22c55e' },
        { label: 'ปิดแล้ว', val: closed, color: '#9ca3af' }
      ];
      const R = 60, CX = 80, CY = 80, C = 2 * Math.PI * R;
      let offset = 0;
      let donutPaths = '';
      donutData.forEach(s => {
        const pct = total ? s.val / total : 0;
        const dash = pct * C;
        donutPaths += `<circle cx="${CX}" cy="${CY}" r="${R}" fill="none" stroke="${s.color}" stroke-width="20" stroke-dasharray="${dash} ${C - dash}" stroke-dashoffset="${-offset}" transform="rotate(-90 ${CX} ${CY})"/>`;
        offset += dash;
      });

      // Bar colors by type filter
      const barColor = dashTypeFilter === 'complaint' ? '#ef4444' : dashTypeFilter === 'compliment' ? '#22c55e' : dashTypeFilter === 'suggestion' ? '#eab308' : '#6366f1';

      // Type bar data
      const typeMax = Math.max(cComplaint, cSuggestion, cCompliment, 1);
      const pctOf = (v) => total ? Math.round(v/allTotal*100) : 0;

      // Progress %
      const pctDone = total ? Math.round(done/total*100) : 0;
      const pctProg = total ? Math.round(inProg/total*100) : 0;
      const pctPend = total ? Math.round(pending/total*100) : 0;

      // ====== Build HTML ======
      let h = '';

      // Filter bar
      const selStyle = 'padding:6px 12px;border:1.5px solid #e5e7eb;border-radius:10px;font-size:0.8125rem;color:#374151;background:white;cursor:pointer;outline:none';
      h += `<div class="dash-filter-bar">`;
      h += `<span style="font-size:0.75rem;color:#6b7280;font-weight:500;margin-right:4px">ตัวกรอง:</span>`;

      // ประเภท
      h += `<select onchange="setDashFilter(this.value)" style="${selStyle}">`;
      h += `<option value="">ประเภท: ทั้งหมด</option>`;
      h += `<option value="complaint"${dashTypeFilter==='complaint'?' selected':''}>🔴 ร้องเรียน</option>`;
      h += `<option value="suggestion"${dashTypeFilter==='suggestion'?' selected':''}>🟡 เสนอแนะ</option>`;
      h += `<option value="compliment"${dashTypeFilter==='compliment'?' selected':''}>🟢 ชมเชย</option>`;
      h += `</select>`;

      // ปี
      h += `<select onchange="setDashFilterYear(this.value)" style="${selStyle}">`;
      h += `<option value="">ปี: ทั้งหมด</option>`;
      availYears.forEach(y => {
        h += `<option value="${y}"${dashFilterYear==String(y)?' selected':''}>${y + 543}</option>`;
      });
      h += `</select>`;

      // เดือน
      const monthNames = ['มกราคม','กุมภาพันธ์','มีนาคม','เมษายน','พฤษภาคม','มิถุนายน','กรกฎาคม','สิงหาคม','กันยายน','ตุลาคม','พฤศจิกายน','ธันวาคม'];
      h += `<select onchange="setDashMonth(this.value)" style="${selStyle}">`;
      h += `<option value="">เดือน: ทั้งหมด</option>`;
      monthNames.forEach((name, idx) => {
        h += `<option value="${idx+1}"${dashMonth==String(idx+1)?' selected':''}>${name}</option>`;
      });
      h += `</select>`;

      // ส่วนงาน
      h += `<select onchange="setDashDept(this.value)" style="${selStyle}">`;
      h += `<option value="">ส่วนงาน: ทั้งหมด</option>`;
      availDepts.forEach(d => {
        h += `<option value="${d}"${dashDept===d?' selected':''}>${d}</option>`;
      });
      h += `</select>`;

      h += `</div>`;

      h += `<div class="dash-grid">`;

      // ── Card 1: Donut ──
      h += `<div class="dash-card">`;
      h += `<div class="dash-card-head"><div><div class="dash-card-title">สถานะรวม</div><div class="dash-card-sub">สัดส่วนตามสถานะปัจจุบัน</div></div></div>`;
      h += `<div class="donut-wrap">`;
      h += `<svg class="donut-svg" width="160" height="160" viewBox="0 0 160 160">`;
      if (total) {
        h += donutPaths;
      } else {
        h += `<circle cx="${CX}" cy="${CY}" r="${R}" fill="none" stroke="#f3f4f6" stroke-width="20"/>`;
      }
      h += `<text x="${CX}" y="${CY-4}" class="donut-center" text-anchor="middle">${total}</text>`;
      h += `<text x="${CX}" y="${CY+14}" class="donut-center-lbl" text-anchor="middle">รายการ</text>`;
      h += `</svg>`;
      h += `<div class="donut-legend">`;
      donutData.forEach(s => {
        h += `<div class="donut-legend-item"><span class="donut-dot" style="background:${s.color}"></span>${s.label}<span class="donut-legend-val">${s.val}</span></div>`;
      });
      h += `</div></div></div>`;

      // ── Card 2: MoM / YoY ──
      h += `<div class="dash-card">`;
      h += `<div class="dash-card-head"><div><div class="dash-card-title">เปรียบเทียบ</div><div class="dash-card-sub">เดือนนี้ vs เดือนก่อน / ปีก่อน</div></div></div>`;
      h += `<div class="mom-grid">`;
      // MoM
      h += `<div class="mom-card">`;
      h += `<div class="mom-label">MoM (เดือนต่อเดือน)</div>`;
      h += `<div class="mom-row"><span class="mom-val">${curCount}</span>${badge(momPct)}</div>`;
      h += `<div class="mom-desc">เดือนก่อน: ${prevCount} รายการ</div>`;
      h += `</div>`;
      // YoY
      h += `<div class="mom-card">`;
      h += `<div class="mom-label">YoY (ปีต่อปี)</div>`;
      h += `<div class="mom-row"><span class="mom-val">${curCount}</span>${badge(yoyPct)}</div>`;
      h += `<div class="mom-desc">เดือนเดียวกันปีก่อน: ${yoyCount} รายการ</div>`;
      h += `</div>`;
      h += `</div></div>`;

      // ── Card 3: Monthly trend ──
      h += `<div class="dash-card">`;
      h += `<div class="dash-card-head"><div><div class="dash-card-title">แนวโน้มรายเดือน</div><div class="dash-card-sub">ม.ค. — ธ.ค. ${dashYear + 543}${dashTypeFilter ? ' — ' + (TYPES[dashTypeFilter]?.th || '') : ''}</div></div>`;
      h += `<select onchange="setDashYear(this.value)" style="padding:4px 10px;border:1.5px solid #e5e7eb;border-radius:8px;font-size:0.75rem;color:#374151;background:white;cursor:pointer;outline:none">`;
      availYears.forEach(y => {
        h += `<option value="${y}"${y===dashYear?' selected':''}>${y + 543}</option>`;
      });
      h += `</select></div>`;
      h += `<div class="bar-chart-wrap">`;
      months.forEach(m => {
        const pct = m.count ? Math.max((m.count/maxMonth)*100, 4) : 2;
        h += `<div class="bar-col"><div class="bar-val">${m.count||''}</div><div class="bar-fill" style="height:${pct}%;background:${barColor}" title="${m.label}: ${m.count}"></div><div class="bar-lbl">${m.label}</div></div>`;
      });
      h += `</div></div>`;

      // ── Card 4: Type breakdown ──
      h += `<div class="dash-card">`;
      h += `<div class="dash-card-head"><div><div class="dash-card-title">ประเภทข้อความ</div><div class="dash-card-sub">จำนวนตามประเภท</div></div></div>`;
      h += `<div class="hbar-row"><span class="hbar-label">ร้องเรียน</span><div class="hbar-track"><div class="hbar-fill" style="width:${cComplaint/typeMax*100}%;background:#ef4444"></div></div><span class="hbar-val">${cComplaint}</span><span class="hbar-pct">${pctOf(cComplaint)}%</span></div>`;
      h += `<div class="hbar-row"><span class="hbar-label">เสนอแนะ</span><div class="hbar-track"><div class="hbar-fill" style="width:${cSuggestion/typeMax*100}%;background:#eab308"></div></div><span class="hbar-val">${cSuggestion}</span><span class="hbar-pct">${pctOf(cSuggestion)}%</span></div>`;
      h += `<div class="hbar-row"><span class="hbar-label">ชมเชย</span><div class="hbar-track"><div class="hbar-fill" style="width:${cCompliment/typeMax*100}%;background:#22c55e"></div></div><span class="hbar-val">${cCompliment}</span><span class="hbar-pct">${pctOf(cCompliment)}%</span></div>`;
      h += `</div>`;

      // ── Card 5: Progress ──
      h += `<div class="dash-card">`;
      h += `<div class="dash-card-head"><div><div class="dash-card-title">ความคืบหน้า</div><div class="dash-card-sub">สถานะการดำเนินงาน${dashTypeFilter ? ' — ' + (TYPES[dashTypeFilter]?.th || '') : ''}</div></div></div>`;
      h += `<div class="prog-bar">`;
      if (pctDone) h += `<div class="prog-fill" style="width:${pctDone}%;background:#22c55e"></div>`;
      if (pctProg) h += `<div class="prog-fill" style="width:${pctProg}%;background:#3b82f6"></div>`;
      if (pctPend) h += `<div class="prog-fill" style="width:${pctPend}%;background:#f59e0b"></div>`;
      h += `</div><div class="prog-stats">`;
      h += `<div class="prog-item"><span class="pval" style="color:#22c55e">${pctDone}%</span><span class="plbl">เสร็จสิ้น</span></div>`;
      h += `<div class="prog-item"><span class="pval" style="color:#3b82f6">${pctProg}%</span><span class="plbl">กำลังดำเนินการ</span></div>`;
      h += `<div class="prog-item"><span class="pval" style="color:#f59e0b">${pctPend}%</span><span class="plbl">รอดำเนินการ</span></div>`;
      h += `</div></div>`;

      // ── Card 6: Top 10 Stations ──
      const stationCount = {};
      src.forEach(d => {
        const st = d.detail_station || 'ไม่ระบุ';
        stationCount[st] = (stationCount[st] || 0) + 1;
      });
      const topStations = Object.entries(stationCount)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);
      const maxStation = topStations.length ? topStations[0][1] : 1;
      const stColors = ['#6366f1','#8b5cf6','#a78bfa','#c4b5fd','#7c3aed','#4f46e5','#818cf8','#6d28d9','#5b21b6','#a5b4fc'];

      h += `<div class="dash-card" style="grid-column:1/-1">`;
      h += `<div class="dash-card-head"><div><div class="dash-card-title">Top 10 สถานี</div><div class="dash-card-sub">สถานีที่มีรายการมากที่สุด</div></div></div>`;
      if (topStations.length) {
        topStations.forEach(([name, count], idx) => {
          const pct = (count / maxStation) * 100;
          h += `<div class="hbar-row">`;
          h += `<span style="font-size:0.6875rem;color:#9ca3af;min-width:22px;text-align:center;font-weight:600">${idx + 1}</span>`;
          h += `<span class="hbar-label">${name}</span>`;
          h += `<div class="hbar-track"><div class="hbar-fill" style="width:${pct}%;background:${stColors[idx % stColors.length]}"></div></div>`;
          h += `<span class="hbar-val">${count}</span>`;
          h += `<span class="hbar-pct">${total ? Math.round(count / total * 100) : 0}%</span>`;
          h += `</div>`;
        });
      } else {
        h += `<div style="padding:20px;text-align:center;color:#9ca3af;font-size:0.8125rem">ไม่มีข้อมูล</div>`;
      }
      h += `</div>`;

      h += `</div>`; // close dash-grid
      container.innerHTML = h;
    }

    // ── Calendar view ──
    let calYear = new Date().getFullYear();
    let calMonth = new Date().getMonth();

    function changeCalMonth(dir) {
      calMonth += dir;
      if (calMonth < 0) { calMonth = 11; calYear--; }
      if (calMonth > 11) { calMonth = 0; calYear++; }
      renderCalendar();
    }

    function renderCalendar() {
      const thMonths = ['มกราคม','กุมภาพันธ์','มีนาคม','เมษายน','พฤษภาคม','มิถุนายน',
                        'กรกฎาคม','สิงหาคม','กันยายน','ตุลาคม','พฤศจิกายน','ธันวาคม'];
      const thDays = ['อา','จ','อ','พ','พฤ','ศ','ส'];
      document.getElementById('calMonthLabel').textContent = thMonths[calMonth] + ' ' + (calYear + 543);

      const firstDay = new Date(calYear, calMonth, 1).getDay();
      const daysInMonth = new Date(calYear, calMonth + 1, 0).getDate();

      // Group items by date
      const itemsByDate = {};
      allData.forEach(item => {
        if (!item.timestamp) return;
        const d = new Date(item.timestamp);
        if (d.getFullYear() === calYear && d.getMonth() === calMonth) {
          const day = d.getDate();
          if (!itemsByDate[day]) itemsByDate[day] = [];
          itemsByDate[day].push(item);
        }
      });

      let h = '';
      // Day headers
      thDays.forEach(d => {
        h += `<div style="padding:8px 4px;text-align:center;font-size:0.7rem;font-weight:700;color:#9ca3af">${d}</div>`;
      });

      // Empty cells before first day
      for (let i = 0; i < firstDay; i++) {
        h += `<div></div>`;
      }

      // Date cells
      for (let day = 1; day <= daysInMonth; day++) {
        const items = itemsByDate[day] || [];
        const isToday = (day === new Date().getDate() && calMonth === new Date().getMonth() && calYear === new Date().getFullYear());
        const hasItems = items.length > 0;

        let cellStyle = 'padding:6px 4px;text-align:center;border-radius:12px;min-height:56px;font-size:0.8rem;transition:all 0.15s;';
        if (isToday) cellStyle += 'background:#eff6ff;border:2px solid #3b82f6;font-weight:700;color:#3b82f6;';
        else if (hasItems) cellStyle += 'background:#f9fafb;cursor:pointer;';
        else cellStyle += 'color:#6b7280;';

        const onclick = hasItems ? ` onclick="openTab('${items[0].id}')"` : '';

        h += `<div style="${cellStyle}"${onclick}>`;
        h += `<div style="font-weight:${isToday?'700':'600'};margin-bottom:2px">${day}</div>`;

        if (hasItems) {
          h += `<div style="display:flex;gap:3px;justify-content:center;flex-wrap:wrap">`;
          items.slice(0, 4).forEach(item => {
            const tc = getTabColor(item.type);
            h += `<span style="width:8px;height:8px;border-radius:50%;background:${tc.dot};display:inline-block" title="${item.subject || ''}"></span>`;
          });
          if (items.length > 4) h += `<span style="font-size:0.55rem;color:#9ca3af">+${items.length - 4}</span>`;
          h += `</div>`;
        }
        h += `</div>`;
      }

      document.getElementById('calGrid').innerHTML = h;
    }

    // ── Trash functions ──
    function moveToTrash(id) {
      const idx = allData.findIndex(d => String(d.id) === String(id));
      if (idx === -1) return;
      if (!confirm('ย้ายรายการนี้ไปถังขยะ?')) return;
      const item = allData.splice(idx, 1)[0];
      item._trashedAt = new Date().toISOString();
      trashData.push(item);
      localStorage.setItem('vfc_trash', JSON.stringify(trashData));
      // Close modal tab if open
      closeTab(String(id));
      applyFilters();
      renderDashboard();
      updateTrashCount();
    }

    function restoreFromTrash(id) {
      const idx = trashData.findIndex(d => String(d.id) === String(id));
      if (idx === -1) return;
      const item = trashData.splice(idx, 1)[0];
      delete item._trashedAt;
      allData.push(item);
      localStorage.setItem('vfc_trash', JSON.stringify(trashData));
      applyFilters();
      renderDashboard();
      renderTrash();
      updateTrashCount();
    }

    function emptyTrash() {
      if (!trashData.length) return;
      if (!confirm(`ลบถาวร ${trashData.length} รายการ? การกระทำนี้ไม่สามารถย้อนกลับได้`)) return;
      trashData = [];
      localStorage.setItem('vfc_trash', JSON.stringify(trashData));
      renderTrash();
      updateTrashCount();
    }

    function updateTrashCount() {
      const el = document.getElementById('trashCount');
      if (!el) return;
      if (trashData.length > 0) {
        el.textContent = trashData.length;
        el.style.display = 'inline';
      } else {
        el.style.display = 'none';
      }
    }

    function renderTrash() {
      const container = document.getElementById('trashList');
      if (!container) return;
      if (!trashData.length) {
        container.innerHTML = `<div style="text-align:center;padding:60px 20px;color:#9ca3af">
          <svg style="width:48px;height:48px;margin:0 auto 12px;opacity:0.3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
          <p style="font-size:0.9rem;font-weight:600">ถังขยะว่าง</p>
          <p style="font-size:0.75rem">รายการที่ลบจะแสดงที่นี่</p>
        </div>`;
        return;
      }

      let h = '';
      trashData.forEach(item => {
        const tp = TYPES[item.type] || { th: item.type, cls: '' };
        const tc = getTabColor(item.type);
        const trashedDate = item._trashedAt ? fmtDate(item._trashedAt) : '-';
        h += `<div style="display:flex;align-items:center;gap:12px;padding:14px 16px;border-radius:14px;background:#fafafa;border:1px solid #f3f4f6;margin-bottom:8px;transition:all 0.15s">`;
        h += `<div style="width:36px;height:36px;border-radius:50%;background:${tc.bg};display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:0.8rem;flex-shrink:0">${(item.reporter_name || item.subject || '?').charAt(0)}</div>`;
        h += `<div style="flex:1;min-width:0">`;
        h += `<div style="font-weight:600;font-size:0.85rem;color:#111827;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${item.subject || 'ไม่มีหัวข้อ'}</div>`;
        h += `<div style="font-size:0.72rem;color:#9ca3af;display:flex;gap:8px;align-items:center;margin-top:2px">`;
        h += `<span class="badge ${tp.cls}" style="font-size:0.65rem;padding:2px 8px">${tp.th}</span>`;
        h += `<span>ลบเมื่อ ${trashedDate}</span>`;
        h += `</div></div>`;
        h += `<button onclick="restoreFromTrash('${item.id}')" style="background:#3b82f6;color:white;border:none;border-radius:8px;padding:6px 12px;font-size:0.72rem;font-weight:600;cursor:pointer;white-space:nowrap">กู้คืน</button>`;
        h += `<button onclick="permanentDelete('${item.id}')" style="background:none;color:#ef4444;border:1px solid #fecaca;border-radius:8px;padding:6px 12px;font-size:0.72rem;font-weight:600;cursor:pointer;white-space:nowrap">ลบถาวร</button>`;
        h += `</div>`;
      });
      container.innerHTML = h;
    }

    function permanentDelete(id) {
      if (!confirm('ลบรายการนี้ถาวร?')) return;
      trashData = trashData.filter(d => String(d.id) !== String(id));
      localStorage.setItem('vfc_trash', JSON.stringify(trashData));
      renderTrash();
      updateTrashCount();
    }

    // Kanban board render
    function renderBoard() {
      const cols = [
        { key: 'pending',       label: 'รอดำเนินการ' },
        { key: 'in_progress',   label: 'กำลังดำเนินการ' },
        { key: 'investigating', label: 'กำลังตรวจสอบ' },
        { key: 'follow_up',     label: 'ติดตามผล' },
        { key: 'resolved',      label: 'เสร็จสิ้น' }
      ];
      const board = document.getElementById('kanbanBoard');
      let html = '';
      cols.forEach(col => {
        const items = allData.filter(d => (d.status || 'pending') === col.key);
        html += `<div class="kanban-col" data-status="${col.key}">`;
        html += `<div class="kanban-col-head">${col.label} <span class="col-count">${items.length}</span></div>`;
        html += `<div class="kanban-cards">`;
        if (!items.length) {
          html += `<div class="kanban-empty">ไม่มีรายการ</div>`;
        } else {
          items.forEach(r => {
            const tp = TYPES[r.type] || { th: r.type, cls: '' };
            const catColors = {
              complaint:  'background:#fee2e2;color:#dc2626',
              compliment: 'background:#dcfce7;color:#16a34a',
              suggestion: 'background:#fef9c3;color:#ca8a04'
            };
            const catStyle = catColors[r.type] || 'background:#f3f4f6;color:#6b7280';
            html += `<div class="kanban-card" onclick="openDetail('${r.id}')">`;
            html += `<div class="kanban-card-title">${r.subject || 'ไม่มีหัวข้อ'}</div>`;
            html += `<span class="kanban-card-cat" style="${catStyle}">${tp.th}</span>`;
            if (r.category) html += ` <span class="kanban-card-cat" style="background:#e0e7ff;color:#4338ca">${catTh(r.category)}</span>`;
            html += `<div class="kanban-card-footer">`;
            html += `<span class="kanban-card-trk">${r.tracking_number || '-'}</span>`;
            html += `<span class="kanban-card-date">${fmtDate(r.created_at).split(' ')[0]}</span>`;
            html += `</div></div>`;
          });
        }
        html += `</div></div>`;
      });
      board.innerHTML = html;
    }

    // Read status (localStorage)
    const READ_KEY = 'vfc_read_ids';
    function getReadIds() {
      try { return JSON.parse(localStorage.getItem(READ_KEY) || '[]'); }
      catch { return []; }
    }
    function markAsRead(id) {
      const ids = getReadIds();
      if (!ids.includes(String(id))) {
        ids.push(String(id));
        localStorage.setItem(READ_KEY, JSON.stringify(ids));
      }
    }
    function markAsUnread(id) {
      let ids = getReadIds();
      ids = ids.filter(x => x !== String(id));
      localStorage.setItem(READ_KEY, JSON.stringify(ids));
    }
    function isRead(id) {
      return getReadIds().includes(String(id));
    }
    function isNew(item) {
      if (!item.created_at) return false;
      return (Date.now() - new Date(item.created_at).getTime()) < 24 * 60 * 60 * 1000;
    }

    // Pin status (localStorage)
    const PIN_KEY = 'vfc_pinned_ids';
    function getPinnedIds() {
      try { return JSON.parse(localStorage.getItem(PIN_KEY) || '[]'); }
      catch { return []; }
    }
    function togglePin(id, e) {
      if (e) { e.stopPropagation(); }
      let ids = getPinnedIds();
      const sid = String(id);
      if (ids.includes(sid)) {
        ids = ids.filter(x => x !== sid);
      } else {
        ids.push(sid);
      }
      localStorage.setItem(PIN_KEY, JSON.stringify(ids));
      render();
    }
    function isPinned(id) {
      return getPinnedIds().includes(String(id));
    }

    // Supabase helper
    const sb = () => window.supabaseClient;
    function waitSB() {
      return new Promise(r => { const c = () => sb() ? r(sb()) : setTimeout(c, 100); c(); });
    }

    // Type config
    const TYPES = {
      complaint:  { th: 'ร้องเรียน', cls: 'b-complaint' },
      compliment: { th: 'ชมเชย',     cls: 'b-compliment' },
      suggestion: { th: 'เสนอแนะ',   cls: 'b-suggestion' }
    };
    const STATUS = {
      pending:       'รอดำเนินการ',
      in_progress:   'กำลังดำเนินการ',
      investigating: 'กำลังตรวจสอบ',
      follow_up:     'ติดตามผล',
      resolved:      'เสร็จสิ้น'
    };

    // Format date → DD/MM/YYYY HH:MM
    function fmtDate(s) {
      if (!s) return '-';
      const d = new Date(s);
      const pad = n => String(n).padStart(2, '0');
      return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()+543} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    // Generate document number: VFC-YYMM-DeptCode-001 (reset per year)
    function genDocNums(data) {
      const counters = {};
      // Sort by created_at ascending for correct numbering
      const sorted = [...data].sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
      const docMap = {};

      sorted.forEach(item => {
        if (!item.created_at) { docMap[item.id] = '-'; return; }
        const d = new Date(item.created_at);
        const yy = String(d.getFullYear() + 543).slice(-2);
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        // ใช้ BH เป็นรหัสฝ่ายทั้งหมดตอนนี้
        const deptCode = 'BH';
        // Counter resets per year + dept
        const counterKey = `${yy}-${deptCode}`;
        counters[counterKey] = (counters[counterKey] || 0) + 1;
        const seq = String(counters[counterKey]).padStart(3, '0');
        docMap[item.id] = `VFC-${yy}${mm}-${deptCode}-${seq}`;
      });

      return docMap;
    }

    let docNumMap = {};

    // Fetch
    async function fetchData() {
      const client = await waitSB();
      const { data, error } = await client
        .from('vfc_submissions')
        .select('*')
        .order('created_at', { ascending: false });

      if (error) {
        document.getElementById('tBody').innerHTML = `<tr class="msg-row"><td colspan="11">❌ ${error.message}</td></tr>`;
        return;
      }
      allData = data || [];
      // Exclude items already in trash
      const trashIds = new Set(trashData.map(t => String(t.id)));
      allData = allData.filter(d => !trashIds.has(String(d.id)));
      docNumMap = genDocNums(allData);
      updateStats();
      applyFilters();
      renderDashboard();
      updateTrashCount();
    }

    // Stats
    function updateStats() {
      document.getElementById('sTotal').textContent         = allData.length;
      document.getElementById('sPending').textContent       = allData.filter(d => d.status === 'pending').length;
      document.getElementById('sProgress').textContent      = allData.filter(d => d.status === 'in_progress').length;
      document.getElementById('sInvestigating').textContent = allData.filter(d => d.status === 'investigating').length;
      document.getElementById('sFollowUp').textContent      = allData.filter(d => d.status === 'follow_up').length;
      document.getElementById('sResolved').textContent      = allData.filter(d => d.status === 'resolved').length;
    }

    // Filter
    function applyFilters() {
      const t = document.getElementById('fType').value;
      const s = document.getElementById('fStatus').value;
      const q = document.getElementById('fSearch').value.toLowerCase().trim();
      const dateFrom = document.getElementById('fDateFrom').value;
      const dateTo = document.getElementById('fDateTo').value;

      const rd = document.getElementById('fRead').value;

      filtered = allData.filter(item => {
        if (t && item.type !== t) return false;
        if (s && item.status !== s) return false;
        if (rd === 'unread' && isRead(item.id)) return false;
        if (rd === 'read' && !isRead(item.id)) return false;
        if (rd === 'pinned' && !isPinned(item.id)) return false;
        if (dateFrom && item.created_at) {
          const itemDate = new Date(item.created_at).toISOString().slice(0, 10);
          if (itemDate < dateFrom) return false;
        }
        if (dateTo && item.created_at) {
          const itemDate = new Date(item.created_at).toISOString().slice(0, 10);
          if (itemDate > dateTo) return false;
        }
        if (q) {
          const txt = [item.tracking_number, item.subject, item.category,
            item.detail_station, item.detail_department, item.reporter_name
          ].filter(Boolean).join(' ').toLowerCase();
          if (!txt.includes(q)) return false;
        }
        return true;
      });
      // Sort: pinned first
      filtered.sort((a, b) => {
        const pa = isPinned(a.id) ? 0 : 1;
        const pb = isPinned(b.id) ? 0 : 1;
        return pa - pb;
      });
      page = 1;
      render();
    }

    // Render table
    function render() {
      const tbody = document.getElementById('tBody');
      const start = (page - 1) * PER, end = start + PER;
      const rows = filtered.slice(start, end);

      if (!rows.length) {
        tbody.innerHTML = '<tr class="msg-row"><td colspan="11">ไม่พบข้อมูล</td></tr>';
        renderPgn();
        return;
      }

      tbody.innerHTML = rows.map(r => {
        const tp = TYPES[r.type] || { th: r.type, cls: '' };
        const st = r.status || 'pending';
        const docNum = docNumMap[r.id] || '-';
        const unread = !isRead(r.id);
        const isNewItem = isNew(r);
        const pinned = isPinned(r.id);
        let rowCls = '';
        if (pinned) rowCls += ' row-pinned';
        if (unread) rowCls += ' row-unread';
        const pinSvg = pinned
          ? '<svg fill="currentColor" viewBox="0 0 16 16"><path d="M4.146.146A.5.5 0 014.5 0h7a.5.5 0 01.5.5c0 .68-.342 1.174-.646 1.479-.126.125-.25.224-.354.298v4.431l.078.048c.203.127.476.314.751.555C12.36 7.775 13 8.527 13 9.5a.5.5 0 01-.5.5H8.5v5.5a.5.5 0 01-1 0V10H3.5a.5.5 0 01-.5-.5c0-.973.64-1.725 1.17-2.189A5.921 5.921 0 015 6.708V2.277a2.77 2.77 0 01-.354-.298C4.342 1.674 4 1.18 4 .5a.5.5 0 01.146-.354z"/></svg>'
          : '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/></svg>';
        return `<tr class="${rowCls.trim()}" onclick="openDetail('${r.id}')">
          <td style="text-align:center;width:36px;padding:0">
            ${unread ? (isNewItem ? '<span class="new-tag">new</span>' : '<span class="unread-dot"></span>') : ''}
          </td>
          <td style="white-space:nowrap;font-weight:500">${pinned ? '<span class="pin-icon">📌</span> ' : ''}${docNum}</td>
          <td><span class="trk">${r.tracking_number || '-'}</span></td>
          <td><span class="badge ${tp.cls}">${tp.th}</span></td>
          <td><span class="txt-trunc">${r.subject || '-'}</span></td>
          <td>${catTh(r.category)}</td>
          <td>${r.detail_station || '-'}</td>
          <td>${r.detail_department || '-'}</td>
          <td><span class="s-badge s-${st}"><span class="dot"></span>${STATUS[st] || st}</span></td>
          <td style="white-space:nowrap">${fmtDate(r.created_at)}</td>
          <td><button class="act-btn ${pinned ? 'pinned' : ''}" onclick="togglePin('${r.id}', event)" title="${pinned ? 'เลิกปักมุด' : 'ปักมุด'}">${pinSvg}</button></td>
        </tr>`;
      }).join('');
      renderPgn();
    }

    // Pagination
    function renderPgn() {
      const total = Math.ceil(filtered.length / PER);
      const s = (page-1)*PER+1, e = Math.min(page*PER, filtered.length);
      document.getElementById('pInfo').textContent = filtered.length ? `${s}-${e} จาก ${filtered.length}` : 'ไม่มีรายการ';

      const el = document.getElementById('pBtns');
      if (total <= 1) { el.innerHTML = ''; return; }

      let h = `<button class="pg-btn" onclick="goPage(${page-1})" ${page===1?'disabled':''}>‹</button>`;
      for (let i = 1; i <= total; i++) {
        if (i===1||i===total||(i>=page-1&&i<=page+1))
          h += `<button class="pg-btn ${i===page?'act':''}" onclick="goPage(${i})">${i}</button>`;
        else if (i===page-2||i===page+2)
          h += `<span style="padding:5px 3px;color:#ccc">…</span>`;
      }
      h += `<button class="pg-btn" onclick="goPage(${page+1})" ${page===total?'disabled':''}>›</button>`;
      el.innerHTML = h;
    }

    function goPage(p) {
      const total = Math.ceil(filtered.length / PER);
      if (p < 1 || p > total) return;
      page = p; render();
    }

    // ========================================
    // Tab-based Modal System
    // ========================================
    const openTabs = []; // { id, minimized }
    let activeTabId = null;

    const TAB_COLORS = {
      complaint: { bg: 'linear-gradient(135deg,#f87171,#ef4444)', dot: '#ef4444' },
      suggestion: { bg: 'linear-gradient(135deg,#60a5fa,#3b82f6)', dot: '#3b82f6' },
      compliment: { bg: 'linear-gradient(135deg,#34d399,#10b981)', dot: '#10b981' },
    };

    function getTabColor(type) { return TAB_COLORS[type] || { bg: 'linear-gradient(135deg,#9ca3af,#6b7280)', dot: '#6b7280' }; }

    // ── Render pill rail (vertical tab pills) ──
    function renderTabBar() {
      const rail = document.getElementById('mDotRail');
      const visibleTabs = openTabs.filter(t => !t.minimized);
      let h = '';
      visibleTabs.forEach(tab => {
        const item = allData.find(d => String(d.id) === String(tab.id));
        if (!item) return;
        const tp = TYPES[item.type] || { th: item.type };
        const isActive = tab.id === activeTabId;
        const label = (item.subject || tp.th || 'รายการ').substring(0, 14);
        h += `<div class="m-dot ${isActive ? 'active' : ''}" onclick="switchModalTab('${tab.id}')">`;
        h += `<span class="m-dot-label">${label}</span>`;
        h += `<button class="m-dot-x" onclick="event.stopPropagation(); closeTab('${tab.id}')">✕</button>`;
        h += `</div>`;
      });
      rail.innerHTML = h;
    }

    // ── Render minimized dock ──
    function renderDock() {
      const dock = document.getElementById('mDock');
      const minimized = openTabs.filter(t => t.minimized);
      if (!minimized.length) { dock.innerHTML = ''; return; }

      let h = '';
      minimized.forEach(tab => {
        const item = allData.find(d => String(d.id) === String(tab.id));
        if (!item) return;
        const tp = TYPES[item.type] || { th: item.type };
        const tc = getTabColor(item.type);
        const initials = item.is_anonymous ? '?' : ((item.reporter_name || item.subject || '?').charAt(0));
        const label = (item.subject || tp.th || 'รายการ').substring(0, 20);
        h += `<div class="m-dock-item" onclick="restoreTab('${tab.id}')">`;
        h += `<span class="m-dock-icon" style="background:${tc.bg}">${initials}</span>`;
        h += `<span class="m-dock-label">${label}</span>`;
        h += `</div>`;
      });
      dock.innerHTML = h;
    }

    // ── Render content for a tab ──
    function renderTabContent(id) {
      const item = allData.find(d => String(d.id) === String(id));
      if (!item) return;

      const tp = TYPES[item.type] || { th: item.type, cls: '' };
      const st = item.status || 'pending';
      const subject = item.subject || 'ไม่มีหัวข้อ';
      const senderName = item.is_anonymous ? 'ไม่ระบุตัวตน' : (item.reporter_name || 'ไม่ระบุชื่อ');
      const initials = item.is_anonymous ? '?' : (senderName.charAt(0) || '?');
      const senderSub = [item.reporter_employee_id, item.reporter_station, item.reporter_department].filter(Boolean).join(' · ');

      // ── Left content ──
      let left = '';
      left += '<div class="m-meta">';
      left += `<span class="badge ${tp.cls}">${tp.th}</span>`;
      left += `<span class="s-badge s-${st}"><span class="dot"></span>${STATUS[st]||st}</span>`;
      left += `<span class="trk">${item.tracking_number || ''}</span>`;
      left += `<span style="margin-left:auto">${fmtDate(item.created_at)}</span>`;
      left += '</div>';
      left += `<div class="m-subject">${subject}</div>`;
      left += '<div class="m-sender-card">';
      left += `<div class="m-avatar">${initials}</div>`;
      left += '<div>';
      left += `<div class="m-sender-name">${senderName}</div>`;
      left += `<div class="m-sender-sub">${senderSub || 'ไม่ระบุข้อมูลผู้ส่ง'}</div>`;
      left += '</div></div>';
      if (item.detail_text) {
        left += '<div class="m-label">รายละเอียด</div>';
        left += `<div class="m-body">${item.detail_text}</div>`;
      }
      if (item.fix_text) {
        left += '<div class="m-fix">';
        left += '<svg class="m-fix-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>';
        left += `<div><strong>สิ่งที่ต้องการแก้ไข</strong><br>${item.fix_text}</div>`;
        left += '</div>';
      }
      const infoItems = [
        ['หมวดหมู่', item.category ? catTh(item.category) : null], ['สถานี', item.detail_station],
        ['ฝ่าย', item.detail_department], ['แผนก', item.detail_section],
      ].filter(([,v]) => v);
      if (infoItems.length) {
        left += '<div class="m-label">ข้อมูลเพิ่มเติม</div>';
        left += '<div class="m-info-table">';
        infoItems.forEach(([l,v]) => {
          left += `<div class="m-info-row-item"><div class="m-info-label">${l}</div><div class="m-info-val">${v}</div></div>`;
        });
        left += '</div>';
      }
      document.getElementById('mContent').innerHTML = left;

      // ── Right sidebar ──
      let right = '';
      const statusOpts = [
        { val: 'pending', label: 'รอดำเนินการ' },
        { val: 'in_progress', label: 'กำลังดำเนินการ' },
        { val: 'investigating', label: 'กำลังตรวจสอบ' },
        { val: 'follow_up', label: 'ติดตามผล' },
        { val: 'resolved', label: 'เสร็จสิ้น' }
      ];
      right += '<div class="m-sb-section">';
      right += '<div class="m-sb-label">สถานะ</div>';
      right += '<div class="m-status-pills" id="mStatusPills">';
      statusOpts.forEach(o => {
        right += `<button class="m-s-pill ${o.val===st?'active':''}" data-val="${o.val}" onclick="selectStatusPill(this)">${o.label}</button>`;
      });
      right += '</div>';
      right += `<button class="m-sb-btn" onclick="updateStatus('${id}')">บันทึกสถานะ</button>`;
      right += '<div id="statusMsg" class="m-sb-msg"></div>';
      right += '</div>';

      right += '<div class="m-sb-section">';
      right += '<div class="m-sb-label">ตอบกลับ</div>';
      right += `<textarea id="mReplyText" class="m-sb-textarea" placeholder="พิมพ์คำตอบหรือบันทึกการดำเนินการ...">${item.admin_response || ''}</textarea>`;
      right += `<button class="m-sb-btn" onclick="saveReply('${id}')">บันทึกคำตอบ</button>`;
      right += '<div id="replyMsg" class="m-sb-msg"></div>';
      right += '</div>';

      const pinned = isPinned(id);
      right += '<div class="m-sb-actions">';
      right += `<button class="m-act-btn2" onclick="togglePin('${id}'); render()">`;
      right += `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/></svg>`;
      right += `${pinned ? 'เลิกปักมุด' : 'ปักมุด'}</button>`;
      right += `<button class="m-act-btn2" onclick="markAsUnread('${id}'); closeTab('${id}'); render()">`;
      right += '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>';
      right += 'ยังไม่อ่าน</button>';
      right += `<button class="m-act-btn2" style="color:#ef4444" onclick="moveToTrash('${id}')">`;
      right += '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>';
      right += 'ย้ายไปถังขยะ</button>';
      right += '</div>';
      document.getElementById('mSidebar').innerHTML = right;
    }

    // ── Open detail (add or switch tab) ──
    function openDetail(id) {
      const sid = String(id);
      const existing = openTabs.find(t => t.id === sid);
      if (existing) {
        existing.minimized = false;
        activeTabId = sid;
      } else {
        openTabs.push({ id: sid, minimized: false });
        activeTabId = sid;
      }

      // Restore all minimized tabs so they show in the tab bar
      openTabs.forEach(t => t.minimized = false);

      renderTabContent(activeTabId);
      renderTabBar();
      renderDock();
      document.getElementById('detailModal').classList.add('open');
      markAsRead(id);
      render();
    }

    // ── Switch modal tab ──
    function switchModalTab(id) {
      activeTabId = String(id);
      renderTabContent(activeTabId);
      renderTabBar();
    }

    // ── Close tab ──
    function closeTab(id) {
      const idx = openTabs.findIndex(t => t.id === String(id));
      if (idx === -1) return;
      openTabs.splice(idx, 1);

      if (openTabs.length === 0) {
        activeTabId = null;
        document.getElementById('detailModal').classList.remove('open');
      } else {
        // Switch to nearest visible tab
        const visible = openTabs.filter(t => !t.minimized);
        if (visible.length) {
          activeTabId = visible[visible.length - 1].id;
          renderTabContent(activeTabId);
          renderTabBar();
        } else {
          activeTabId = null;
          document.getElementById('detailModal').classList.remove('open');
        }
      }
      renderTabBar();
      renderDock();
    }

    function closeActiveTab() {
      if (activeTabId) closeTab(activeTabId);
    }

    // ── Minimize ──
    function minimizeActiveTab() {
      if (!activeTabId) return;
      const tab = openTabs.find(t => t.id === activeTabId);
      if (tab) tab.minimized = true;

      // Find next visible tab
      const visible = openTabs.filter(t => !t.minimized);
      if (visible.length) {
        activeTabId = visible[visible.length - 1].id;
        renderTabContent(activeTabId);
        renderTabBar();
      } else {
        activeTabId = null;
        document.getElementById('detailModal').classList.remove('open');
      }
      renderTabBar();
      renderDock();
    }

    // ── Minimize ALL tabs ──
    function minimizeAllTabs() {
      openTabs.forEach(t => t.minimized = true);
      activeTabId = null;
      document.getElementById('detailModal').classList.remove('open');
      renderTabBar();
      renderDock();
    }

    // ── Close ALL tabs ──
    function closeAllTabs() {
      openTabs = [];
      activeTabId = null;
      document.getElementById('detailModal').classList.remove('open');
      renderTabBar();
      renderDock();
    }

    // ── Restore from dock ──
    function restoreTab(id) {
      // Restore ALL minimized tabs
      openTabs.forEach(t => t.minimized = false);
      activeTabId = String(id);

      renderTabContent(activeTabId);
      renderTabBar();
      renderDock();
      document.getElementById('detailModal').classList.add('open');
    }

    // ── Close modal (legacy) ──
    function closeModal() {
      if (activeTabId) minimizeActiveTab();
      else document.getElementById('detailModal').classList.remove('open');
    }

    // Status pill selector
    function selectStatusPill(el) {
      el.closest('.m-status-pills').querySelectorAll('.m-s-pill').forEach(b => b.classList.remove('active'));
      el.classList.add('active');
    }

    // Update status in Supabase
    async function updateStatus(id) {
      const activeP = document.querySelector('.m-s-pill.active');
      const newStatus = activeP ? activeP.dataset.val : 'pending';
      const msgEl = document.getElementById('statusMsg');
      msgEl.textContent = 'กำลังบันทึก...';
      msgEl.style.color = '#6b7280';

      const client = await waitSB();
      const { error } = await client
        .from('vfc_submissions')
        .update({ status: newStatus })
        .eq('id', id);

      if (error) {
        msgEl.textContent = '❌ เกิดข้อผิดพลาด: ' + error.message;
        msgEl.style.color = '#ef4444';
        return;
      }

      const item = allData.find(d => String(d.id) === String(id));
      if (item) item.status = newStatus;

      msgEl.textContent = '✅ บันทึกสถานะเรียบร้อย';
      msgEl.style.color = '#22c55e';
      updateStats();
      applyFilters();
      renderDashboard();
      setTimeout(() => { msgEl.textContent = ''; }, 3000);
    }

    // Save admin reply to Supabase
    async function saveReply(id) {
      const text = document.getElementById('mReplyText').value.trim();
      const msgEl = document.getElementById('replyMsg');
      msgEl.textContent = 'กำลังบันทึก...';
      msgEl.style.color = '#6b7280';

      const client = await waitSB();
      const { error } = await client
        .from('vfc_submissions')
        .update({ admin_response: text })
        .eq('id', id);

      if (error) {
        msgEl.textContent = '❌ เกิดข้อผิดพลาด: ' + error.message;
        msgEl.style.color = '#ef4444';
        return;
      }

      const item = allData.find(d => String(d.id) === String(id));
      if (item) item.admin_response = text;

      msgEl.textContent = '✅ บันทึกคำตอบเรียบร้อย';
      msgEl.style.color = '#22c55e';
      setTimeout(() => { msgEl.textContent = ''; }, 3000);
    }

    // Keyboard
    document.addEventListener('keydown', e => { if (e.key === 'Escape') minimizeActiveTab(); });

    // Refresh
    function refreshData() {
      document.getElementById('tBody').innerHTML = '<tr class="msg-row"><td colspan="11">กำลังโหลดข้อมูล...</td></tr>';
      fetchData();
    }

    // Notification
    function updateNotifDot() {
      const unreadCount = allData.filter(d => !isRead(d.id)).length;
      const dot = document.getElementById('notifDot');
      if (dot) dot.style.display = unreadCount > 0 ? 'block' : 'none';
    }
    function toggleNotifPanel() {
      const unreadCount = allData.filter(d => !isRead(d.id)).length;
      if (unreadCount > 0) {
        alert('คุณมี ' + unreadCount + ' รายการที่ยังไม่ได้อ่าน');
      } else {
        alert('ไม่มีการแจ้งเตือนใหม่');
      }
    }

    // Init
    document.addEventListener('DOMContentLoaded', async () => {
      await fetchData();
      updateNotifDot();
    });
  </script>
</body>
</html>
