<!doctype html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VFC Admin - Voice for Change</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="../../../function/shared/css/fonts.css" />
  <link rel="stylesheet" href="../../../function/admin/css/admin-base.css" />
  <script src="../../../function/admin/components/admin-nav.js"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="../../../function/shared/js/supabase-config.js"></script>

  <style>
    /* Layout */
    .admin-content {
      margin-left: 80px;
      padding: 24px 32px;
      min-height: 100vh;
    }
    @media (max-width: 1023px) {
      .admin-content {
        margin-left: 0;
        padding: 80px 16px 24px;
      }
    }

    /* Stats */
    .stat-card {
      background: white;
      border-radius: 16px;
      padding: 20px 24px;
      border: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      gap: 16px;
      transition: box-shadow 0.2s;
    }
    .stat-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.06); }
    .stat-icon {
      width: 44px; height: 44px;
      border-radius: 12px;
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0;
    }
    .stat-val { font-size: 1.5rem; font-weight: 700; color: #111827; line-height: 1; }
    .stat-lbl { font-size: 0.75rem; color: #9ca3af; margin-top: 2px; }

    /* Table card */
    .tbl-card {
      background: white;
      border-radius: 20px;
      border: 1px solid #e5e7eb;
      overflow: hidden;
    }
    .filter-card {
      background: white;
      border-radius: 16px;
      border: 1px solid #e5e7eb;
      padding: 14px 20px;
      margin-bottom: 12px;
    }
    .tbl-head {
      padding: 16px 24px;
      border-bottom: 1px solid #f3f4f6;
      display: flex; align-items: center; justify-content: space-between;
      flex-wrap: wrap; gap: 12px;
    }

    /* Filters */
    .f-select {
      padding: 7px 12px; border-radius: 10px;
      border: 1px solid #e5e7eb; font-size: 0.8125rem;
      color: #374151; background: white; outline: none;
      cursor: pointer;
    }
    .f-select:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }
    .f-search {
      padding: 7px 12px 7px 34px; border-radius: 10px;
      border: 1px solid #e5e7eb; font-size: 0.8125rem;
      outline: none; width: 200px; background: white;
    }
    .f-search:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }

    /* Table */
    .dtbl { width: 100%; border-collapse: collapse; }
    .dtbl thead th {
      padding: 10px 16px; text-align: left;
      font-size: 0.6875rem; font-weight: 600; color: #9ca3af;
      text-transform: uppercase; letter-spacing: 0.05em;
      border-bottom: 1px solid #f3f4f6; white-space: nowrap;
    }
    .dtbl tbody tr {
      border-bottom: 1px solid #f9fafb;
      transition: background 0.15s; cursor: pointer;
    }
    .dtbl tbody tr:hover { background: #f9fafb; }
    .dtbl tbody td {
      padding: 12px 16px; font-size: 0.8125rem;
      color: #374151; vertical-align: middle;
    }

    /* Badges */
    .badge {
      display: inline-flex; align-items: center; gap: 4px;
      padding: 3px 10px; border-radius: 999px;
      font-size: 0.6875rem; font-weight: 500; white-space: nowrap;
    }
    .b-complaint { background: #fef2f2; color: #dc2626; }
    .b-compliment { background: #f0fdf4; color: #16a34a; }
    .b-suggestion { background: #eff6ff; color: #2563eb; }

    .s-badge {
      display: inline-flex; align-items: center; gap: 5px;
      padding: 3px 10px; border-radius: 999px;
      font-size: 0.6875rem; font-weight: 500; white-space: nowrap;
    }
    .s-badge .dot { width: 6px; height: 6px; border-radius: 50%; }
    .s-pending { background: #fffbeb; color: #d97706; }
    .s-pending .dot { background: #f59e0b; }
    .s-in_progress { background: #eff6ff; color: #2563eb; }
    .s-in_progress .dot { background: #3b82f6; }
    .s-resolved { background: #f0fdf4; color: #16a34a; }
    .s-resolved .dot { background: #22c55e; }
    .s-closed { background: #f3f4f6; color: #6b7280; }
    .s-closed .dot { background: #9ca3af; }

    /* Tracking */
    .trk { font-family: 'SF Mono','Fira Code',monospace; font-size: 0.75rem; color: #6366f1; font-weight: 500; }
    .txt-trunc { max-width: 220px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; display: block; }

    /* Unread indicator */
    .row-unread { background: #f8faff; font-weight: 500; }
    .row-unread:hover { background: #f0f4ff; }

    /* Pin */
    .row-pinned { background: #fffbeb; }
    .row-pinned:hover { background: #fef3c7; }
    .row-pinned.row-unread { background: #fef9e7; }
    .pin-icon { color: #d97706; font-size: 0.75rem; }

    /* Action btns */
    .act-btn {
      width: 28px; height: 28px; border-radius: 6px;
      border: none; background: transparent; cursor: pointer;
      display: inline-flex; align-items: center; justify-content: center;
      transition: background 0.15s; color: #9ca3af;
    }
    .act-btn:hover { background: #f3f4f6; color: #374151; }
    .act-btn.pinned { color: #d97706; }
    .act-btn svg { width: 14px; height: 14px; }

    /* Modal actions */
    .modal-actions {
      display: flex; gap: 8px; padding: 16px 24px;
      border-top: 1px solid #f3f4f6;
    }
    .m-act-btn {
      display: inline-flex; align-items: center; gap: 5px;
      padding: 7px 14px; border-radius: 8px; border: 1px solid #e5e7eb;
      font-size: 0.75rem; color: #374151; background: white;
      cursor: pointer; transition: all 0.15s;
    }
    .m-act-btn:hover { background: #f3f4f6; }
    .m-act-btn.active { background: #fffbeb; border-color: #fbbf24; color: #92400e; }
    .m-act-btn svg { width: 14px; height: 14px; }
    .unread-dot {
      width: 8px; height: 8px; border-radius: 50%;
      background: #3b82f6; display: inline-block; flex-shrink: 0;
    }
    .new-tag {
      display: inline-block; padding: 1px 6px; border-radius: 4px;
      font-size: 0.625rem; font-weight: 700; background: #ef4444; color: white;
      text-transform: uppercase; letter-spacing: 0.05em; margin-left: 6px;
      animation: pulse-new 2s infinite;
    }
    @keyframes pulse-new {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    /* Pagination */
    .pgn { display: flex; align-items: center; justify-content: space-between; padding: 14px 24px; border-top: 1px solid #f3f4f6; }
    .pgn-info { font-size: 0.8125rem; color: #6b7280; }
    .pgn-btns { display: flex; gap: 4px; }
    .pg-btn {
      padding: 5px 11px; border-radius: 8px; border: 1px solid #e5e7eb;
      font-size: 0.8125rem; color: #374151; background: white;
      cursor: pointer; transition: all 0.15s;
    }
    .pg-btn:hover { background: #f3f4f6; }
    .pg-btn.act { background: #3b82f6; color: white; border-color: #3b82f6; }
    .pg-btn:disabled { opacity: 0.35; cursor: not-allowed; }

    /* Loading / Empty */
    .msg-row td { text-align: center; padding: 48px 16px !important; color: #9ca3af; font-size: 0.875rem; }

    /* Scroll */
    .tbl-scroll { overflow-x: auto; }

    /* Refresh btn */
    .btn-ref {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 7px 16px; border-radius: 10px; border: 1px solid #e5e7eb;
      font-size: 0.8125rem; color: #374151; background: white;
      cursor: pointer; transition: all 0.15s;
    }
    .btn-ref:hover { background: #f3f4f6; }
    .btn-ref svg { width: 15px; height: 15px; }

    /* Detail modal */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.35);
      backdrop-filter: blur(4px); z-index: 100;
      display: flex; align-items: center; justify-content: center;
      padding: 16px; opacity: 0; visibility: hidden; transition: all 0.25s;
    }
    .modal-overlay.open { opacity: 1; visibility: visible; }
    .modal-box {
      background: white; border-radius: 16px; width: 100%; max-width: 900px;
      max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 60px rgba(0,0,0,0.18);
      transform: translateY(20px); transition: transform 0.25s;
    }
    .modal-overlay.open .modal-box { transform: translateY(0); }

    /* Email-style header */
    .email-header {
      padding: 20px 28px 16px; border-bottom: 1px solid #f3f4f6;
    }
    .email-subject {
      font-size: 1.125rem; font-weight: 700; color: #111827;
      margin-bottom: 4px; line-height: 1.4;
    }
    .email-meta-row {
      display: flex; align-items: center; gap: 8px; flex-wrap: wrap;
      margin-top: 8px; font-size: 0.75rem; color: #9ca3af;
    }
    .email-close {
      position: absolute; top: 18px; right: 20px;
      width: 32px; height: 32px; border-radius: 8px; border: none;
      background: transparent; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      color: #9ca3af; transition: all 0.15s;
    }
    .email-close:hover { background: #f3f4f6; color: #374151; }

    /* Sender info */
    .email-sender {
      padding: 14px 28px; display: flex; align-items: center; gap: 12px;
      border-bottom: 1px solid #f3f4f6;
    }
    .email-avatar {
      width: 40px; height: 40px; border-radius: 50%;
      background: linear-gradient(135deg, #a78bfa, #7c3aed);
      display: flex; align-items: center; justify-content: center;
      color: white; font-weight: 700; font-size: 0.875rem; flex-shrink: 0;
    }
    .email-sender-name { font-size: 0.8125rem; font-weight: 600; color: #111827; }
    .email-sender-detail { font-size: 0.6875rem; color: #9ca3af; }

    /* Email body */
    .email-body { padding: 24px 28px; }
    .email-content {
      font-size: 0.875rem; color: #374151; line-height: 1.7;
      white-space: pre-wrap; word-break: break-word;
    }
    .email-detail-grid {
      display: grid; grid-template-columns: 1fr 1fr; gap: 12px;
      margin-top: 20px; padding: 16px; background: #f9fafb;
      border-radius: 12px;
    }
    @media (max-width: 600px) { .email-detail-grid { grid-template-columns: 1fr; } }
    .email-detail-item {}
    .email-detail-label { font-size: 0.6875rem; color: #9ca3af; font-weight: 500; text-transform: uppercase; letter-spacing: 0.03em; }
    .email-detail-val { font-size: 0.8125rem; color: #111827; font-weight: 500; margin-top: 2px; }

    /* Modal form controls */
    .modal-section { padding: 16px 28px; border-top: 1px solid #f3f4f6; }
    .modal-section-title { font-size: 0.8125rem; font-weight: 600; color: #374151; margin-bottom: 10px; }
    .modal-select {
      width: 100%; padding: 8px 12px; border-radius: 10px;
      border: 1.5px solid #e5e7eb; font-size: 0.8125rem;
      color: #374151; background: white; outline: none; cursor: pointer;
    }
    .modal-select:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }
    .modal-textarea {
      width: 100%; padding: 12px 14px; border-radius: 12px;
      border: 1.5px solid #e5e7eb; font-size: 0.8125rem;
      color: #374151; outline: none; resize: vertical; min-height: 80px;
      font-family: inherit; line-height: 1.6;
    }
    .modal-textarea:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }
    .modal-save-btn {
      padding: 8px 20px; border-radius: 10px; border: none;
      font-size: 0.8125rem; font-weight: 600;
      cursor: pointer; transition: all 0.2s;
      background: #3b82f6; color: white;
    }
    .modal-save-btn:hover { background: #2563eb; }
    .modal-save-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .modal-save-msg {
      font-size: 0.75rem; margin-top: 6px; min-height: 18px;
    }
    .modal-actions {
      padding: 14px 28px; border-top: 1px solid #f3f4f6;
      display: flex; gap: 8px; flex-wrap: wrap;
    }

    /* Tab bar ‚Äî underline style */
    .tab-bar {
      display: flex; align-items: center; gap: 0;
      border-bottom: 2px solid #e5e7eb;
      width: 100%; margin-bottom: 20px;
    }
    .tab-btn {
      padding: 10px 20px; border: none; border-bottom: 2px solid transparent;
      margin-bottom: -2px; font-size: 0.8125rem; font-weight: 500;
      cursor: pointer; transition: all 0.15s;
      background: transparent; color: #6b7280; white-space: nowrap;
      display: flex; align-items: center; gap: 6px;
    }
    .tab-btn:hover { color: #111827; }
    .tab-btn.active { color: #2563eb; border-bottom-color: #2563eb; font-weight: 600; }
    .tab-btn.active:hover { color: #1d4ed8; border-bottom-color: #1d4ed8; }

    /* Mobile: icons only */
    @media (max-width: 640px) {
      .tab-bar { justify-content: center; }
      .tab-btn { padding: 10px 16px; font-size: 0; gap: 0; }
      .tab-btn svg { width: 20px; height: 20px; }
    }
    .tab-placeholder {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      min-height: 400px; color: #9ca3af; gap: 12px;
    }
    .tab-placeholder svg { width: 48px; height: 48px; opacity: 0.4; }
    .tab-placeholder p { font-size: 0.875rem; }

    /* Kanban Board */
    .kanban-wrap {
      display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px;
      min-height: calc(100vh - 200px); align-items: start;
    }
    @media (max-width: 1024px) {
      .kanban-wrap { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 640px) {
      .kanban-wrap { grid-template-columns: 1fr; }
    }
    .kanban-col {
      background: #f4f5f7; border-radius: 12px;
      display: flex; flex-direction: column;
      max-height: calc(100vh - 200px);
    }
    .kanban-col-head {
      padding: 12px 16px; font-size: 0.75rem; font-weight: 700;
      text-transform: uppercase; letter-spacing: 0.05em;
      color: #5e6c84; display: flex; align-items: center; gap: 8px;
      border-bottom: 2px solid transparent; flex-shrink: 0;
    }
    .kanban-col-head .col-count {
      background: #dfe1e6; color: #44546f; border-radius: 10px;
      padding: 0 7px; font-size: 0.6875rem; font-weight: 600; min-width: 20px;
      text-align: center; line-height: 20px;
    }
    .kanban-col[data-status="pending"] .kanban-col-head { border-bottom-color: #f59e0b; }
    .kanban-col[data-status="in_progress"] .kanban-col-head { border-bottom-color: #3b82f6; }
    .kanban-col[data-status="resolved"] .kanban-col-head { border-bottom-color: #22c55e; }
    .kanban-col[data-status="closed"] .kanban-col-head { border-bottom-color: #9ca3af; }
    .kanban-cards {
      padding: 8px; overflow-y: auto; flex: 1;
      display: flex; flex-direction: column; gap: 8px;
    }
    .kanban-cards::-webkit-scrollbar { width: 4px; }
    .kanban-cards::-webkit-scrollbar-thumb { background: #c1c7d0; border-radius: 4px; }
    .kanban-card {
      background: white; border-radius: 8px; padding: 12px;
      border: 1px solid #dfe1e6; cursor: pointer;
      transition: box-shadow 0.15s, border-color 0.15s;
    }
    .kanban-card:hover {
      box-shadow: 0 1px 5px rgba(9,30,66,0.15);
      border-color: #c1c7d0;
    }
    .kanban-card-title {
      font-size: 0.8125rem; font-weight: 500; color: #172b4d;
      margin-bottom: 8px; line-height: 1.4;
      display: -webkit-box; -webkit-line-clamp: 2;
      -webkit-box-orient: vertical; overflow: hidden;
    }
    .kanban-card-cat {
      display: inline-block; padding: 1px 6px; border-radius: 4px;
      font-size: 0.625rem; font-weight: 700;
      margin-bottom: 8px;
    }
    .kanban-card-footer {
      display: flex; align-items: center; justify-content: space-between;
      font-size: 0.6875rem; color: #5e6c84;
    }
    .kanban-card-trk {
      font-family: 'SF Mono','Fira Code',monospace;
      font-size: 0.6875rem; color: #6366f1;
    }
    .kanban-card-date { color: #97a0af; font-size: 0.625rem; }
    .kanban-empty {
      text-align: center; padding: 24px 12px;
      color: #b3bac5; font-size: 0.75rem;
    }

    /* ====== Power BI Dashboard ====== */
    .dash-grid {
      display: grid; grid-template-columns: 1fr 1fr; gap: 16px;
    }
    @media (max-width: 768px) { .dash-grid { grid-template-columns: 1fr; } }
    .dash-card {
      background: white; border: 1px solid #e5e7eb; border-radius: 14px;
      padding: 20px; overflow: hidden;
    }
    .dash-card-full { grid-column: 1 / -1; }
    .dash-card-head {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 16px;
    }
    .dash-card-title {
      font-size: 0.875rem; font-weight: 600; color: #111827;
    }
    .dash-card-sub {
      font-size: 0.6875rem; color: #9ca3af; margin-top: 2px;
    }
    /* Type filter pills */
    .dash-filter-bar {
      display: flex; align-items: center; gap: 6px; flex-wrap: wrap; margin-bottom: 16px;
    }
    .dash-filter-pill {
      padding: 5px 14px; border-radius: 20px; border: 1.5px solid #e5e7eb;
      font-size: 0.75rem; font-weight: 500; cursor: pointer;
      transition: all 0.2s; background: white; color: #6b7280;
    }
    .dash-filter-pill:hover { border-color: #c7d2fe; background: #f5f3ff; }
    .dash-filter-pill.active {
      background: #4f46e5; color: white; border-color: #4f46e5;
    }
    /* Donut */
    .donut-wrap {
      display: flex; align-items: center; gap: 24px;
    }
    @media (max-width: 480px) { .donut-wrap { flex-direction: column; } }
    .donut-svg { flex-shrink: 0; }
    .donut-svg circle {
      transition: stroke-dasharray 0.6s ease, stroke-dashoffset 0.6s ease;
    }
    .donut-center {
      font-size: 1.5rem; font-weight: 700; fill: #111827;
    }
    .donut-center-lbl {
      font-size: 0.625rem; fill: #9ca3af;
    }
    .donut-legend { display: flex; flex-direction: column; gap: 8px; min-width: 130px; }
    .donut-legend-item {
      display: flex; align-items: center; gap: 8px;
      font-size: 0.8125rem; color: #374151; cursor: pointer;
    }
    .donut-legend-item:hover { color: #111827; }
    .donut-dot {
      width: 12px; height: 12px; border-radius: 3px; flex-shrink: 0;
    }
    .donut-legend-val {
      margin-left: auto; font-weight: 600; color: #111827;
    }
    /* MoM / YoY cards */
    .mom-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 480px) { .mom-grid { grid-template-columns: 1fr; } }
    .mom-card {
      background: #f9fafb; border-radius: 10px; padding: 14px 16px;
      display: flex; flex-direction: column; gap: 4px;
    }
    .mom-label { font-size: 0.6875rem; color: #6b7280; font-weight: 500; }
    .mom-row { display: flex; align-items: baseline; gap: 8px; }
    .mom-val { font-size: 1.5rem; font-weight: 700; color: #111827; }
    .mom-badge {
      display: inline-flex; align-items: center; gap: 3px;
      font-size: 0.6875rem; font-weight: 600;
      padding: 2px 8px; border-radius: 12px;
    }
    .mom-up { background: #dcfce7; color: #16a34a; }
    .mom-down { background: #fee2e2; color: #dc2626; }
    .mom-flat { background: #f3f4f6; color: #6b7280; }
    .mom-desc { font-size: 0.625rem; color: #9ca3af; }
    /* Bar chart */
    .bar-chart-wrap {
      display: flex; align-items: flex-end; gap: 6px; height: 160px;
      padding: 8px 0;
    }
    .bar-col {
      flex: 1; display: flex; flex-direction: column; align-items: center;
      gap: 4px; height: 100%; justify-content: flex-end;
    }
    .bar-fill {
      width: 100%; max-width: 56px; border-radius: 5px 5px 0 0;
      transition: height 0.5s ease; position: relative;
      cursor: pointer;
    }
    .bar-fill:hover { opacity: 0.85; }
    .bar-val {
      font-size: 0.625rem; font-weight: 600; color: #374151;
    }
    .bar-lbl {
      font-size: 0.6875rem; color: #6b7280; white-space: nowrap;
    }

    /* Horizontal bars */
    .hbar-row {
      display: flex; align-items: center; gap: 10px; margin-bottom: 10px;
    }
    .hbar-label {
      font-size: 0.75rem; color: #374151; min-width: 80px; font-weight: 500;
    }
    .hbar-track {
      flex: 1; height: 14px; background: #f3f4f6; border-radius: 7px;
      overflow: hidden;
    }
    .hbar-fill {
      height: 100%; border-radius: 7px; transition: width 0.5s ease;
    }
    .hbar-val {
      font-size: 0.75rem; font-weight: 600; color: #111827; min-width: 30px;
      text-align: right;
    }
    .hbar-pct {
      font-size: 0.625rem; color: #9ca3af; min-width: 35px; text-align: right;
    }
    /* Progress */
    .prog-bar {
      height: 14px; border-radius: 7px; background: #f3f4f6;
      overflow: hidden; display: flex; margin-bottom: 12px;
    }
    .prog-fill { height: 100%; transition: width 0.5s ease; }
    .prog-stats {
      display: flex; gap: 20px;
    }
    .prog-item { display: flex; flex-direction: column; }
    .prog-item .pval { font-size: 1.25rem; font-weight: 700; }
    .prog-item .plbl { font-size: 0.625rem; color: #9ca3af; }
  </style>
</head>
<body class="bg-white min-h-screen">
  <!-- Admin Navigation -->
  <div id="adminNavContainer" data-admin-nav="vfc"></div>

  <!-- Main Content -->
  <div class="admin-content">

    <!-- Header -->
    <div class="mb-4">
      <h1 class="text-xl font-bold text-gray-900">Voice for Change</h1>
      <p class="text-sm text-gray-500 mt-0.5">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏ä‡∏°‡πÄ‡∏ä‡∏¢ ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞</p>
    </div>

    <!-- Floating Navbar - Right: Search Circle + Bell Circle -->
    <div class="fixed top-4 right-4 z-50">
      <div class="flex items-center gap-3">
        <!-- Search Button (Circle) -->
        <button onclick="document.getElementById('fSearch').focus(); switchTab('table');" class="flex items-center justify-center w-14 h-14 bg-white/80 backdrop-blur-xl rounded-full border border-gray-200 hover:bg-gray-50 transition-colors">
          <svg class="w-5 h-5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
          </svg>
        </button>
        <!-- Bell Button -->
        <button onclick="toggleNotifPanel()" class="flex items-center justify-center w-14 h-14 bg-white/80 backdrop-blur-xl rounded-full border border-gray-200 hover:bg-gray-50 transition-colors relative">
          <svg class="w-5 h-5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
          </svg>
          <span id="notifDot" class="absolute top-3 right-3 w-2.5 h-2.5 bg-red-500 rounded-full" style="display:none;"></span>
        </button>
      </div>
    </div>
    <!-- Tab Bar -->
    <div class="tab-bar" style="margin-bottom:16px">
      <button class="tab-btn active" id="tabInbox" onclick="switchTab('inbox')">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-4 0a1 1 0 01-1-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 01-1 1"/></svg>
        ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
      </button>
      <button class="tab-btn" id="tabBoard" onclick="switchTab('board')">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2"/></svg>
        ‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô
      </button>
      <button class="tab-btn" id="tabTable" onclick="switchTab('table')">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/></svg>
        ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
      </button>
      <button class="tab-btn" id="tabSettings" onclick="switchTab('settings')">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
        ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
      </button>
    </div>

    <!-- Tab: Inbox -->
    <div id="contentInbox" class="tab-content">

    <!-- Stats -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
      <div class="stat-card">
        <div class="stat-icon bg-indigo-50">
          <svg class="w-5 h-5 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
        </div>
        <div><div class="stat-val" id="sTotal">-</div><div class="stat-lbl">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div></div>
      </div>
      <div class="stat-card">
        <div class="stat-icon bg-amber-50">
          <svg class="w-5 h-5 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        </div>
        <div><div class="stat-val" id="sPending">-</div><div class="stat-lbl">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</div></div>
      </div>
      <div class="stat-card">
        <div class="stat-icon bg-blue-50">
          <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
        </div>
        <div><div class="stat-val" id="sProgress">-</div><div class="stat-lbl">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</div></div>
      </div>
      <div class="stat-card">
        <div class="stat-icon bg-green-50">
          <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        </div>
        <div><div class="stat-val" id="sResolved">-</div><div class="stat-lbl">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</div></div>
      </div>
    </div>

    <!-- Dashboard: Interactive Charts -->
    <div id="dashCharts"></div>

    </div>

    <!-- Tab: Kanban Board -->
    <div id="contentBoard" class="tab-content hidden">
      <div class="kanban-wrap" id="kanbanBoard"></div>
    </div>



    <!-- Tab: Settings -->
    <div id="contentSettings" class="tab-content hidden">
      <div class="tab-placeholder">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
        <p>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ ‚Äî Settings</p>
      </div>
    </div>

    <!-- Tab: Table -->
    <div id="contentTable" class="tab-content hidden">
    <!-- Filter Card -->
    <div class="filter-card">
      <div class="flex items-center justify-between flex-wrap gap-3">
        <div class="flex items-center gap-2 flex-wrap">
          <select id="fType" onchange="applyFilters()" class="f-select">
            <option value="">‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</option>
            <option value="complaint">‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>
            <option value="compliment">‡∏ä‡∏°‡πÄ‡∏ä‡∏¢</option>
            <option value="suggestion">‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞</option>
          </select>
          <select id="fStatus" onchange="applyFilters()" class="f-select">
            <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
            <option value="pending">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
            <option value="in_progress">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
            <option value="resolved">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</option>
            <option value="closed">‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß</option>
          </select>
          <div class="flex items-center gap-1.5">
            <input type="date" id="fDateFrom" onchange="applyFilters()" class="f-select" title="‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà">
            <span class="text-gray-400 text-xs">‡∏ñ‡∏∂‡∏á</span>
            <input type="date" id="fDateTo" onchange="applyFilters()" class="f-select" title="‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà">
          </div>
          <select id="fRead" onchange="applyFilters()" class="f-select">
            <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
            <option value="unread">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡πà‡∏≤‡∏ô</option>
            <option value="read">‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß</option>
            <option value="pinned">‡∏õ‡∏±‡∏Å‡∏°‡∏∏‡∏î</option>
          </select>
        </div>
        <div class="relative">
          <svg class="w-4 h-4 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
          <input type="text" id="fSearch" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." class="f-search" oninput="applyFilters()">
        </div>
      </div>
    </div>

    <!-- Table Card -->
    <div class="tbl-card">

      <!-- Table -->
      <div class="tbl-scroll">
        <table class="dtbl">
          <thead>
            <tr>
              <th style="width:36px"></th>
              <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</th>
              <th>‡πÄ‡∏•‡∏Ç‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</th>
              <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
              <th>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</th>
              <th>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</th>
              <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ</th>
              <th>‡∏ù‡πà‡∏≤‡∏¢</th>
              <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
              <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
              <th style="width:40px"></th>
            </tr>
          </thead>
          <tbody id="tBody">
            <tr class="msg-row"><td colspan="11">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="pgn">
        <div class="pgn-info" id="pInfo">-</div>
        <div class="pgn-btns" id="pBtns"></div>
      </div>
    </div>
    </div><!-- /contentTable -->

  </div><!-- /admin-content -->
  <!-- Detail Modal -->
  <div id="detailModal" class="modal-overlay" onclick="if(event.target===this)closeModal()">
    <div class="modal-box" style="position:relative">
      <button onclick="closeModal()" class="email-close">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
      <div id="mEmailContent"></div>
      <div class="modal-actions" id="mActions"></div>
    </div>
  </div>

  <script>
    // ========================================
    // VFC Admin ‚Äî Supabase Data Table
    // ========================================
    let allData = [], filtered = [], page = 1;
    const PER = 20;

    // Tab switching
    function switchTab(tabName) {
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelectorAll('.tab-content').forEach(c => {
        c.classList.add('hidden');
      });
      const btnId = 'tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1);
      const contentId = 'content' + tabName.charAt(0).toUpperCase() + tabName.slice(1);
      document.getElementById(btnId).classList.add('active');
      document.getElementById(contentId).classList.remove('hidden');
      if (tabName === 'board') renderBoard();
      if (tabName === 'inbox') renderDashboard();
    }

    // Dashboard ‚Äî Power BI style
    let dashTypeFilter = '';
    let dashYear = new Date().getFullYear();
    let dashMonth = '';
    let dashFilterYear = '';
    let dashDept = '';
    function setDashFilter(type) {
      dashTypeFilter = type;
      renderDashboard();
    }
    function setDashYear(y) {
      dashYear = parseInt(y);
      renderDashboard();
    }
    function setDashMonth(m) {
      dashMonth = m;
      renderDashboard();
    }
    function setDashFilterYear(y) {
      dashFilterYear = y;
      renderDashboard();
    }
    function setDashDept(d) {
      dashDept = d;
      renderDashboard();
    }
    function renderDashboard() {
      // Apply all dashboard filters
      let src = [...allData];
      if (dashTypeFilter) src = src.filter(d => d.type === dashTypeFilter);
      if (dashFilterYear) src = src.filter(d => d.created_at && new Date(d.created_at).getFullYear() === parseInt(dashFilterYear));
      if (dashMonth) src = src.filter(d => d.created_at && (new Date(d.created_at).getMonth() + 1) === parseInt(dashMonth));
      if (dashDept) src = src.filter(d => (d.detail_department || '') === dashDept);
      const total = src.length;
      const allTotal = allData.length;
      const container = document.getElementById('dashCharts');
      if (!allTotal) { container.innerHTML = ''; return; }

      // Available years from data
      const yearsSet = new Set();
      allData.forEach(r => { if (r.created_at) yearsSet.add(new Date(r.created_at).getFullYear()); });
      yearsSet.add(new Date().getFullYear());
      const availYears = [...yearsSet].sort((a,b) => b - a);

      // Available departments from data
      const deptSet = new Set();
      allData.forEach(r => { if (r.detail_department) deptSet.add(r.detail_department); });
      const availDepts = [...deptSet].sort();

      // Counts by type (from filtered src)
      const cComplaint = src.filter(d => d.type === 'complaint').length;
      const cSuggestion = src.filter(d => d.type === 'suggestion').length;
      const cCompliment = src.filter(d => d.type === 'compliment').length;

      // Status counts
      const pending = src.filter(d => !d.status || d.status === 'pending').length;
      const inProg = src.filter(d => d.status === 'in_progress').length;
      const resolved = src.filter(d => d.status === 'resolved').length;
      const closed = src.filter(d => d.status === 'closed').length;
      const done = resolved + closed;

      // MoM / YoY
      const now = new Date();
      const getMonthKey = (y, m) => y + '-' + String(m+1).padStart(2,'0');
      const curMonthKey = getMonthKey(now.getFullYear(), now.getMonth());
      const prevMonth = new Date(now.getFullYear(), now.getMonth()-1, 1);
      const prevMonthKey = getMonthKey(prevMonth.getFullYear(), prevMonth.getMonth());
      const sameMonthLastYear = new Date(now.getFullYear()-1, now.getMonth(), 1);
      const yoyKey = getMonthKey(sameMonthLastYear.getFullYear(), sameMonthLastYear.getMonth());

      const countByKey = (key) => src.filter(r => r.created_at && r.created_at.startsWith(key)).length;
      const curCount = countByKey(curMonthKey);
      const prevCount = countByKey(prevMonthKey);
      const yoyCount = countByKey(yoyKey);

      const momPct = prevCount ? Math.round((curCount - prevCount) / prevCount * 100) : (curCount ? 100 : 0);
      const yoyPct = yoyCount ? Math.round((curCount - yoyCount) / yoyCount * 100) : (curCount ? 100 : 0);

      const badge = (pct) => {
        if (pct > 0) return `<span class="mom-badge mom-up">‚ñ≤ +${pct}%</span>`;
        if (pct < 0) return `<span class="mom-badge mom-down">‚ñº ${pct}%</span>`;
        return `<span class="mom-badge mom-flat">‚Äî 0%</span>`;
      };

      // Monthly Jan-Dec for selected year
      const monthFull = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå','‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°','‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô','‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°','‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô','‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°','‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô','‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°','‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô','‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];
      const monthShort = ['‡∏°.‡∏Ñ.','‡∏Å.‡∏û.','‡∏°‡∏µ.‡∏Ñ.','‡πÄ‡∏°.‡∏¢.','‡∏û.‡∏Ñ.','‡∏°‡∏¥.‡∏¢.','‡∏Å.‡∏Ñ.','‡∏™.‡∏Ñ.','‡∏Å.‡∏¢.','‡∏ï.‡∏Ñ.','‡∏û.‡∏¢.','‡∏ò.‡∏Ñ.'];
      const isWide = window.innerWidth >= 768;
      const months = [];
      for (let m = 0; m < 12; m++) {
        const key = dashYear + '-' + String(m+1).padStart(2,'0');
        const count = src.filter(r => r.created_at && r.created_at.startsWith(key)).length;
        months.push({ label: isWide ? monthFull[m] : monthShort[m], count, key });
      }
      const maxMonth = Math.max(...months.map(m => m.count), 1);

      // Donut
      const donutData = [
        { label: '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', val: pending, color: '#f59e0b' },
        { label: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', val: inProg, color: '#3b82f6' },
        { label: '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô', val: resolved, color: '#22c55e' },
        { label: '‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß', val: closed, color: '#9ca3af' }
      ];
      const R = 60, CX = 80, CY = 80, C = 2 * Math.PI * R;
      let offset = 0;
      let donutPaths = '';
      donutData.forEach(s => {
        const pct = total ? s.val / total : 0;
        const dash = pct * C;
        donutPaths += `<circle cx="${CX}" cy="${CY}" r="${R}" fill="none" stroke="${s.color}" stroke-width="20" stroke-dasharray="${dash} ${C - dash}" stroke-dashoffset="${-offset}" transform="rotate(-90 ${CX} ${CY})"/>`;
        offset += dash;
      });

      // Bar colors by type filter
      const barColor = dashTypeFilter === 'complaint' ? '#ef4444' : dashTypeFilter === 'compliment' ? '#22c55e' : dashTypeFilter === 'suggestion' ? '#eab308' : '#6366f1';

      // Type bar data
      const typeMax = Math.max(cComplaint, cSuggestion, cCompliment, 1);
      const pctOf = (v) => total ? Math.round(v/allTotal*100) : 0;

      // Progress %
      const pctDone = total ? Math.round(done/total*100) : 0;
      const pctProg = total ? Math.round(inProg/total*100) : 0;
      const pctPend = total ? Math.round(pending/total*100) : 0;

      // ====== Build HTML ======
      let h = '';

      // Filter bar
      const selStyle = 'padding:6px 12px;border:1.5px solid #e5e7eb;border-radius:10px;font-size:0.8125rem;color:#374151;background:white;cursor:pointer;outline:none';
      h += `<div class="dash-filter-bar">`;
      h += `<span style="font-size:0.75rem;color:#6b7280;font-weight:500;margin-right:4px">‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á:</span>`;

      // ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
      h += `<select onchange="setDashFilter(this.value)" style="${selStyle}">`;
      h += `<option value="">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>`;
      h += `<option value="complaint"${dashTypeFilter==='complaint'?' selected':''}>üî¥ ‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>`;
      h += `<option value="suggestion"${dashTypeFilter==='suggestion'?' selected':''}>üü° ‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞</option>`;
      h += `<option value="compliment"${dashTypeFilter==='compliment'?' selected':''}>üü¢ ‡∏ä‡∏°‡πÄ‡∏ä‡∏¢</option>`;
      h += `</select>`;

      // ‡∏õ‡∏µ
      h += `<select onchange="setDashFilterYear(this.value)" style="${selStyle}">`;
      h += `<option value="">‡∏õ‡∏µ: ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>`;
      availYears.forEach(y => {
        h += `<option value="${y}"${dashFilterYear==String(y)?' selected':''}>${y + 543}</option>`;
      });
      h += `</select>`;

      // ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
      const monthNames = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå','‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°','‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô','‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°','‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô','‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°','‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô','‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°','‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô','‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];
      h += `<select onchange="setDashMonth(this.value)" style="${selStyle}">`;
      h += `<option value="">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>`;
      monthNames.forEach((name, idx) => {
        h += `<option value="${idx+1}"${dashMonth==String(idx+1)?' selected':''}>${name}</option>`;
      });
      h += `</select>`;

      // ‡∏™‡πà‡∏ß‡∏ô‡∏á‡∏≤‡∏ô
      h += `<select onchange="setDashDept(this.value)" style="${selStyle}">`;
      h += `<option value="">‡∏™‡πà‡∏ß‡∏ô‡∏á‡∏≤‡∏ô: ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>`;
      availDepts.forEach(d => {
        h += `<option value="${d}"${dashDept===d?' selected':''}>${d}</option>`;
      });
      h += `</select>`;

      h += `</div>`;

      h += `<div class="dash-grid">`;

      // ‚îÄ‚îÄ Card 1: Donut ‚îÄ‚îÄ
      h += `<div class="dash-card">`;
      h += `<div class="dash-card-head"><div><div class="dash-card-title">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏ß‡∏°</div><div class="dash-card-sub">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</div></div></div>`;
      h += `<div class="donut-wrap">`;
      h += `<svg class="donut-svg" width="160" height="160" viewBox="0 0 160 160">`;
      if (total) {
        h += donutPaths;
      } else {
        h += `<circle cx="${CX}" cy="${CY}" r="${R}" fill="none" stroke="#f3f4f6" stroke-width="20"/>`;
      }
      h += `<text x="${CX}" y="${CY-4}" class="donut-center" text-anchor="middle">${total}</text>`;
      h += `<text x="${CX}" y="${CY+14}" class="donut-center-lbl" text-anchor="middle">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</text>`;
      h += `</svg>`;
      h += `<div class="donut-legend">`;
      donutData.forEach(s => {
        h += `<div class="donut-legend-item"><span class="donut-dot" style="background:${s.color}"></span>${s.label}<span class="donut-legend-val">${s.val}</span></div>`;
      });
      h += `</div></div></div>`;

      // ‚îÄ‚îÄ Card 2: MoM / YoY ‚îÄ‚îÄ
      h += `<div class="dash-card">`;
      h += `<div class="dash-card-head"><div><div class="dash-card-title">‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö</div><div class="dash-card-sub">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ vs ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô / ‡∏õ‡∏µ‡∏Å‡πà‡∏≠‡∏ô</div></div></div>`;
      h += `<div class="mom-grid">`;
      // MoM
      h += `<div class="mom-card">`;
      h += `<div class="mom-label">MoM (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</div>`;
      h += `<div class="mom-row"><span class="mom-val">${curCount}</span>${badge(momPct)}</div>`;
      h += `<div class="mom-desc">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô: ${prevCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>`;
      h += `</div>`;
      // YoY
      h += `<div class="mom-card">`;
      h += `<div class="mom-label">YoY (‡∏õ‡∏µ‡∏ï‡πà‡∏≠‡∏õ‡∏µ)</div>`;
      h += `<div class="mom-row"><span class="mom-val">${curCount}</span>${badge(yoyPct)}</div>`;
      h += `<div class="mom-desc">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏õ‡∏µ‡∏Å‡πà‡∏≠‡∏ô: ${yoyCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>`;
      h += `</div>`;
      h += `</div></div>`;

      // ‚îÄ‚îÄ Card 3: Monthly trend ‚îÄ‚îÄ
      h += `<div class="dash-card">`;
      h += `<div class="dash-card-head"><div><div class="dash-card-title">‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div><div class="dash-card-sub">‡∏°.‡∏Ñ. ‚Äî ‡∏ò.‡∏Ñ. ${dashYear + 543}${dashTypeFilter ? ' ‚Äî ' + (TYPES[dashTypeFilter]?.th || '') : ''}</div></div>`;
      h += `<select onchange="setDashYear(this.value)" style="padding:4px 10px;border:1.5px solid #e5e7eb;border-radius:8px;font-size:0.75rem;color:#374151;background:white;cursor:pointer;outline:none">`;
      availYears.forEach(y => {
        h += `<option value="${y}"${y===dashYear?' selected':''}>${y + 543}</option>`;
      });
      h += `</select></div>`;
      h += `<div class="bar-chart-wrap">`;
      months.forEach(m => {
        const pct = m.count ? Math.max((m.count/maxMonth)*100, 4) : 2;
        h += `<div class="bar-col"><div class="bar-val">${m.count||''}</div><div class="bar-fill" style="height:${pct}%;background:${barColor}" title="${m.label}: ${m.count}"></div><div class="bar-lbl">${m.label}</div></div>`;
      });
      h += `</div></div>`;

      // ‚îÄ‚îÄ Card 4: Type breakdown ‚îÄ‚îÄ
      h += `<div class="dash-card">`;
      h += `<div class="dash-card-head"><div><div class="dash-card-title">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</div><div class="dash-card-sub">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</div></div></div>`;
      h += `<div class="hbar-row"><span class="hbar-label">‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span><div class="hbar-track"><div class="hbar-fill" style="width:${cComplaint/typeMax*100}%;background:#ef4444"></div></div><span class="hbar-val">${cComplaint}</span><span class="hbar-pct">${pctOf(cComplaint)}%</span></div>`;
      h += `<div class="hbar-row"><span class="hbar-label">‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞</span><div class="hbar-track"><div class="hbar-fill" style="width:${cSuggestion/typeMax*100}%;background:#eab308"></div></div><span class="hbar-val">${cSuggestion}</span><span class="hbar-pct">${pctOf(cSuggestion)}%</span></div>`;
      h += `<div class="hbar-row"><span class="hbar-label">‡∏ä‡∏°‡πÄ‡∏ä‡∏¢</span><div class="hbar-track"><div class="hbar-fill" style="width:${cCompliment/typeMax*100}%;background:#22c55e"></div></div><span class="hbar-val">${cCompliment}</span><span class="hbar-pct">${pctOf(cCompliment)}%</span></div>`;
      h += `</div>`;

      // ‚îÄ‚îÄ Card 5: Progress ‚îÄ‚îÄ
      h += `<div class="dash-card">`;
      h += `<div class="dash-card-head"><div><div class="dash-card-title">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</div><div class="dash-card-sub">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô${dashTypeFilter ? ' ‚Äî ' + (TYPES[dashTypeFilter]?.th || '') : ''}</div></div></div>`;
      h += `<div class="prog-bar">`;
      if (pctDone) h += `<div class="prog-fill" style="width:${pctDone}%;background:#22c55e"></div>`;
      if (pctProg) h += `<div class="prog-fill" style="width:${pctProg}%;background:#3b82f6"></div>`;
      if (pctPend) h += `<div class="prog-fill" style="width:${pctPend}%;background:#f59e0b"></div>`;
      h += `</div><div class="prog-stats">`;
      h += `<div class="prog-item"><span class="pval" style="color:#22c55e">${pctDone}%</span><span class="plbl">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</span></div>`;
      h += `<div class="prog-item"><span class="pval" style="color:#3b82f6">${pctProg}%</span><span class="plbl">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span></div>`;
      h += `<div class="prog-item"><span class="pval" style="color:#f59e0b">${pctPend}%</span><span class="plbl">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span></div>`;
      h += `</div></div>`;

      // ‚îÄ‚îÄ Card 6: Top 10 Stations ‚îÄ‚îÄ
      const stationCount = {};
      src.forEach(d => {
        const st = d.detail_station || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
        stationCount[st] = (stationCount[st] || 0) + 1;
      });
      const topStations = Object.entries(stationCount)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);
      const maxStation = topStations.length ? topStations[0][1] : 1;
      const stColors = ['#6366f1','#8b5cf6','#a78bfa','#c4b5fd','#7c3aed','#4f46e5','#818cf8','#6d28d9','#5b21b6','#a5b4fc'];

      h += `<div class="dash-card" style="grid-column:1/-1">`;
      h += `<div class="dash-card-head"><div><div class="dash-card-title">Top 10 ‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ</div><div class="dash-card-sub">‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</div></div></div>`;
      if (topStations.length) {
        topStations.forEach(([name, count], idx) => {
          const pct = (count / maxStation) * 100;
          h += `<div class="hbar-row">`;
          h += `<span style="font-size:0.6875rem;color:#9ca3af;min-width:22px;text-align:center;font-weight:600">${idx + 1}</span>`;
          h += `<span class="hbar-label">${name}</span>`;
          h += `<div class="hbar-track"><div class="hbar-fill" style="width:${pct}%;background:${stColors[idx % stColors.length]}"></div></div>`;
          h += `<span class="hbar-val">${count}</span>`;
          h += `<span class="hbar-pct">${total ? Math.round(count / total * 100) : 0}%</span>`;
          h += `</div>`;
        });
      } else {
        h += `<div style="padding:20px;text-align:center;color:#9ca3af;font-size:0.8125rem">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>`;
      }
      h += `</div>`;

      h += `</div>`; // close dash-grid
      container.innerHTML = h;
    }

    // Kanban board render
    function renderBoard() {
      const cols = [
        { key: 'pending',     label: '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' },
        { key: 'in_progress', label: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' },
        { key: 'resolved',    label: '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' },
        { key: 'closed',      label: '‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß' }
      ];
      const board = document.getElementById('kanbanBoard');
      let html = '';
      cols.forEach(col => {
        const items = allData.filter(d => (d.status || 'pending') === col.key);
        html += `<div class="kanban-col" data-status="${col.key}">`;
        html += `<div class="kanban-col-head">${col.label} <span class="col-count">${items.length}</span></div>`;
        html += `<div class="kanban-cards">`;
        if (!items.length) {
          html += `<div class="kanban-empty">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>`;
        } else {
          items.forEach(r => {
            const tp = TYPES[r.type] || { th: r.type, cls: '' };
            const catColors = {
              complaint:  'background:#fee2e2;color:#dc2626',
              compliment: 'background:#dcfce7;color:#16a34a',
              suggestion: 'background:#fef9c3;color:#ca8a04'
            };
            const catStyle = catColors[r.type] || 'background:#f3f4f6;color:#6b7280';
            html += `<div class="kanban-card" onclick="openDetail('${r.id}')">`;
            html += `<div class="kanban-card-title">${r.subject || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠'}</div>`;
            html += `<span class="kanban-card-cat" style="${catStyle}">${tp.th}</span>`;
            if (r.category) html += ` <span class="kanban-card-cat" style="background:#e0e7ff;color:#4338ca">${r.category}</span>`;
            html += `<div class="kanban-card-footer">`;
            html += `<span class="kanban-card-trk">${r.tracking_number || '-'}</span>`;
            html += `<span class="kanban-card-date">${fmtDate(r.created_at).split(' ')[0]}</span>`;
            html += `</div></div>`;
          });
        }
        html += `</div></div>`;
      });
      board.innerHTML = html;
    }

    // Read status (localStorage)
    const READ_KEY = 'vfc_read_ids';
    function getReadIds() {
      try { return JSON.parse(localStorage.getItem(READ_KEY) || '[]'); }
      catch { return []; }
    }
    function markAsRead(id) {
      const ids = getReadIds();
      if (!ids.includes(String(id))) {
        ids.push(String(id));
        localStorage.setItem(READ_KEY, JSON.stringify(ids));
      }
    }
    function markAsUnread(id) {
      let ids = getReadIds();
      ids = ids.filter(x => x !== String(id));
      localStorage.setItem(READ_KEY, JSON.stringify(ids));
    }
    function isRead(id) {
      return getReadIds().includes(String(id));
    }
    function isNew(item) {
      if (!item.created_at) return false;
      return (Date.now() - new Date(item.created_at).getTime()) < 24 * 60 * 60 * 1000;
    }

    // Pin status (localStorage)
    const PIN_KEY = 'vfc_pinned_ids';
    function getPinnedIds() {
      try { return JSON.parse(localStorage.getItem(PIN_KEY) || '[]'); }
      catch { return []; }
    }
    function togglePin(id, e) {
      if (e) { e.stopPropagation(); }
      let ids = getPinnedIds();
      const sid = String(id);
      if (ids.includes(sid)) {
        ids = ids.filter(x => x !== sid);
      } else {
        ids.push(sid);
      }
      localStorage.setItem(PIN_KEY, JSON.stringify(ids));
      render();
    }
    function isPinned(id) {
      return getPinnedIds().includes(String(id));
    }

    // Supabase helper
    const sb = () => window.supabaseClient;
    function waitSB() {
      return new Promise(r => { const c = () => sb() ? r(sb()) : setTimeout(c, 100); c(); });
    }

    // Type config
    const TYPES = {
      complaint:  { th: '‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', cls: 'b-complaint' },
      compliment: { th: '‡∏ä‡∏°‡πÄ‡∏ä‡∏¢',     cls: 'b-compliment' },
      suggestion: { th: '‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞',   cls: 'b-suggestion' }
    };
    const STATUS = {
      pending:     '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£',
      in_progress: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£',
      resolved:    '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô',
      closed:      '‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß'
    };

    // Format date ‚Üí DD/MM/YYYY HH:MM
    function fmtDate(s) {
      if (!s) return '-';
      const d = new Date(s);
      const pad = n => String(n).padStart(2, '0');
      return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()+543} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    // Generate document number: VFC-YYMM-DeptCode-001 (reset per year)
    function genDocNums(data) {
      const counters = {};
      // Sort by created_at ascending for correct numbering
      const sorted = [...data].sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
      const docMap = {};

      sorted.forEach(item => {
        if (!item.created_at) { docMap[item.id] = '-'; return; }
        const d = new Date(item.created_at);
        const yy = String(d.getFullYear() + 543).slice(-2);
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        // ‡πÉ‡∏ä‡πâ BH ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ù‡πà‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ
        const deptCode = 'BH';
        // Counter resets per year + dept
        const counterKey = `${yy}-${deptCode}`;
        counters[counterKey] = (counters[counterKey] || 0) + 1;
        const seq = String(counters[counterKey]).padStart(3, '0');
        docMap[item.id] = `VFC-${yy}${mm}-${deptCode}-${seq}`;
      });

      return docMap;
    }

    let docNumMap = {};

    // Fetch
    async function fetchData() {
      const client = await waitSB();
      const { data, error } = await client
        .from('vfc_submissions')
        .select('*')
        .order('created_at', { ascending: false });

      if (error) {
        document.getElementById('tBody').innerHTML = `<tr class="msg-row"><td colspan="11">‚ùå ${error.message}</td></tr>`;
        return;
      }
      allData = data || [];
      docNumMap = genDocNums(allData);
      updateStats();
      applyFilters();
      renderDashboard();
    }

    // Stats
    function updateStats() {
      document.getElementById('sTotal').textContent    = allData.length;
      document.getElementById('sPending').textContent   = allData.filter(d => d.status === 'pending').length;
      document.getElementById('sProgress').textContent  = allData.filter(d => d.status === 'in_progress').length;
      document.getElementById('sResolved').textContent  = allData.filter(d => d.status === 'resolved' || d.status === 'closed').length;
    }

    // Filter
    function applyFilters() {
      const t = document.getElementById('fType').value;
      const s = document.getElementById('fStatus').value;
      const q = document.getElementById('fSearch').value.toLowerCase().trim();
      const dateFrom = document.getElementById('fDateFrom').value;
      const dateTo = document.getElementById('fDateTo').value;

      const rd = document.getElementById('fRead').value;

      filtered = allData.filter(item => {
        if (t && item.type !== t) return false;
        if (s && item.status !== s) return false;
        if (rd === 'unread' && isRead(item.id)) return false;
        if (rd === 'read' && !isRead(item.id)) return false;
        if (rd === 'pinned' && !isPinned(item.id)) return false;
        if (dateFrom && item.created_at) {
          const itemDate = new Date(item.created_at).toISOString().slice(0, 10);
          if (itemDate < dateFrom) return false;
        }
        if (dateTo && item.created_at) {
          const itemDate = new Date(item.created_at).toISOString().slice(0, 10);
          if (itemDate > dateTo) return false;
        }
        if (q) {
          const txt = [item.tracking_number, item.subject, item.category,
            item.detail_station, item.detail_department, item.reporter_name
          ].filter(Boolean).join(' ').toLowerCase();
          if (!txt.includes(q)) return false;
        }
        return true;
      });
      // Sort: pinned first
      filtered.sort((a, b) => {
        const pa = isPinned(a.id) ? 0 : 1;
        const pb = isPinned(b.id) ? 0 : 1;
        return pa - pb;
      });
      page = 1;
      render();
    }

    // Render table
    function render() {
      const tbody = document.getElementById('tBody');
      const start = (page - 1) * PER, end = start + PER;
      const rows = filtered.slice(start, end);

      if (!rows.length) {
        tbody.innerHTML = '<tr class="msg-row"><td colspan="11">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
        renderPgn();
        return;
      }

      tbody.innerHTML = rows.map(r => {
        const tp = TYPES[r.type] || { th: r.type, cls: '' };
        const st = r.status || 'pending';
        const docNum = docNumMap[r.id] || '-';
        const unread = !isRead(r.id);
        const isNewItem = isNew(r);
        const pinned = isPinned(r.id);
        let rowCls = '';
        if (pinned) rowCls += ' row-pinned';
        if (unread) rowCls += ' row-unread';
        const pinSvg = pinned
          ? '<svg fill="currentColor" viewBox="0 0 16 16"><path d="M4.146.146A.5.5 0 014.5 0h7a.5.5 0 01.5.5c0 .68-.342 1.174-.646 1.479-.126.125-.25.224-.354.298v4.431l.078.048c.203.127.476.314.751.555C12.36 7.775 13 8.527 13 9.5a.5.5 0 01-.5.5H8.5v5.5a.5.5 0 01-1 0V10H3.5a.5.5 0 01-.5-.5c0-.973.64-1.725 1.17-2.189A5.921 5.921 0 015 6.708V2.277a2.77 2.77 0 01-.354-.298C4.342 1.674 4 1.18 4 .5a.5.5 0 01.146-.354z"/></svg>'
          : '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/></svg>';
        return `<tr class="${rowCls.trim()}" onclick="openDetail('${r.id}')">
          <td style="text-align:center;width:36px;padding:0">
            ${unread ? (isNewItem ? '<span class="new-tag">new</span>' : '<span class="unread-dot"></span>') : ''}
          </td>
          <td style="white-space:nowrap;font-weight:500">${pinned ? '<span class="pin-icon">üìå</span> ' : ''}${docNum}</td>
          <td><span class="trk">${r.tracking_number || '-'}</span></td>
          <td><span class="badge ${tp.cls}">${tp.th}</span></td>
          <td><span class="txt-trunc">${r.subject || '-'}</span></td>
          <td>${r.category || '-'}</td>
          <td>${r.detail_station || '-'}</td>
          <td>${r.detail_department || '-'}</td>
          <td><span class="s-badge s-${st}"><span class="dot"></span>${STATUS[st] || st}</span></td>
          <td style="white-space:nowrap">${fmtDate(r.created_at)}</td>
          <td><button class="act-btn ${pinned ? 'pinned' : ''}" onclick="togglePin('${r.id}', event)" title="${pinned ? '‡πÄ‡∏•‡∏¥‡∏Å‡∏õ‡∏±‡∏Å‡∏°‡∏∏‡∏î' : '‡∏õ‡∏±‡∏Å‡∏°‡∏∏‡∏î'}">${pinSvg}</button></td>
        </tr>`;
      }).join('');
      renderPgn();
    }

    // Pagination
    function renderPgn() {
      const total = Math.ceil(filtered.length / PER);
      const s = (page-1)*PER+1, e = Math.min(page*PER, filtered.length);
      document.getElementById('pInfo').textContent = filtered.length ? `${s}-${e} ‡∏à‡∏≤‡∏Å ${filtered.length}` : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';

      const el = document.getElementById('pBtns');
      if (total <= 1) { el.innerHTML = ''; return; }

      let h = `<button class="pg-btn" onclick="goPage(${page-1})" ${page===1?'disabled':''}>‚Äπ</button>`;
      for (let i = 1; i <= total; i++) {
        if (i===1||i===total||(i>=page-1&&i<=page+1))
          h += `<button class="pg-btn ${i===page?'act':''}" onclick="goPage(${i})">${i}</button>`;
        else if (i===page-2||i===page+2)
          h += `<span style="padding:5px 3px;color:#ccc">‚Ä¶</span>`;
      }
      h += `<button class="pg-btn" onclick="goPage(${page+1})" ${page===total?'disabled':''}>‚Ä∫</button>`;
      el.innerHTML = h;
    }

    function goPage(p) {
      const total = Math.ceil(filtered.length / PER);
      if (p < 1 || p > total) return;
      page = p; render();
    }

    // Detail modal
    function openDetail(id) {
      const item = allData.find(d => String(d.id) === String(id));
      if (!item) return;

      const tp = TYPES[item.type] || { th: item.type, cls: '' };
      const st = item.status || 'pending';
      const subject = item.subject || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠';
      const senderName = item.is_anonymous ? '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏±‡∏ß‡∏ï‡∏ô' : (item.reporter_name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠');
      const initials = item.is_anonymous ? '?' : (senderName.charAt(0) || '?');
      const senderSub = [item.reporter_employee_id, item.reporter_station, item.reporter_department].filter(Boolean).join(' ¬∑ ');

      let html = '';

      // ‚îÄ‚îÄ Email Header ‚îÄ‚îÄ
      html += '<div class="email-header">';
      html += `<div class="email-subject">${subject}</div>`;
      html += '<div class="email-meta-row">';
      html += `<span class="badge ${tp.cls}">${tp.th}</span>`;
      html += `<span class="s-badge s-${st}"><span class="dot"></span>${STATUS[st]||st}</span>`;
      html += `<span class="trk">${item.tracking_number || ''}</span>`;
      html += `<span style="margin-left:auto">${fmtDate(item.created_at)}</span>`;
      html += '</div></div>';

      // ‚îÄ‚îÄ Sender Info ‚îÄ‚îÄ
      html += '<div class="email-sender">';
      html += `<div class="email-avatar">${initials}</div>`;
      html += '<div>';
      html += `<div class="email-sender-name">${senderName}</div>`;
      html += `<div class="email-sender-detail">${senderSub || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á'}</div>`;
      html += '</div></div>';

      // ‚îÄ‚îÄ Email Body ‚îÄ‚îÄ
      html += '<div class="email-body">';
      // Main content text
      if (item.detail_text) {
        html += `<div class="email-content">${item.detail_text}</div>`;
      }
      if (item.fix_text) {
        html += `<div style="margin-top:16px;padding:12px 16px;background:#fef3c7;border-radius:10px;font-size:0.8125rem;color:#92400e;"><strong>‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:</strong> ${item.fix_text}</div>`;
      }
      // Detail grid
      const details = [
        ['‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà', item.category],
        ['‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ', item.detail_station],
        ['‡∏ù‡πà‡∏≤‡∏¢', item.detail_department],
        ['‡πÅ‡∏ú‡∏ô‡∏Å', item.detail_section],
      ].filter(([,v]) => v);
      if (details.length) {
        html += '<div class="email-detail-grid">';
        details.forEach(([l,v]) => {
          html += `<div class="email-detail-item"><div class="email-detail-label">${l}</div><div class="email-detail-val">${v}</div></div>`;
        });
        html += '</div>';
      }
      html += '</div>';

      // ‚îÄ‚îÄ Status Change ‚îÄ‚îÄ
      const statusOpts = [
        { val: 'pending', label: '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' },
        { val: 'in_progress', label: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' },
        { val: 'resolved', label: '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' },
        { val: 'closed', label: '‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß' }
      ];
      html += '<div class="modal-section">';
      html += '<div class="modal-section-title">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div>';
      html += '<div style="display:flex;gap:8px;align-items:center">';
      html += '<select id="mStatusSelect" class="modal-select" style="flex:1">';
      statusOpts.forEach(o => {
        html += `<option value="${o.val}"${o.val === st ? ' selected' : ''}>${o.label}</option>`;
      });
      html += '</select>';
      html += `<button class="modal-save-btn" onclick="updateStatus('${id}')">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>`;
      html += '</div>';
      html += '<div id="statusMsg" class="modal-save-msg"></div>';
      html += '</div>';

      // ‚îÄ‚îÄ Reply Section ‚îÄ‚îÄ
      html += '<div class="modal-section">';
      html += '<div class="modal-section-title">‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö / ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</div>';
      html += `<textarea id="mReplyText" class="modal-textarea" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...">${item.admin_response || ''}</textarea>`;
      html += '<div style="display:flex;justify-content:flex-end;margin-top:8px">';
      html += `<button class="modal-save-btn" onclick="saveReply('${id}')">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>`;
      html += '</div>';
      html += '<div id="replyMsg" class="modal-save-msg"></div>';
      html += '</div>';

      document.getElementById('mEmailContent').innerHTML = html;

      // Action buttons
      const pinned = isPinned(id);
      document.getElementById('mActions').innerHTML = `
        <button class="m-act-btn ${pinned ? 'active' : ''}" onclick="togglePin('${id}'); updateModalActions('${id}')">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/></svg>
          ${pinned ? '‡πÄ‡∏•‡∏¥‡∏Å‡∏õ‡∏±‡∏Å‡∏°‡∏∏‡∏î' : '‡∏õ‡∏±‡∏Å‡∏°‡∏∏‡∏î'}
        </button>
        <button class="m-act-btn" onclick="markAsUnread('${id}'); closeModal(); render()">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
          ‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏≠‡πà‡∏≤‡∏ô
        </button>
      `;

      document.getElementById('detailModal').classList.add('open');
      markAsRead(id);
      render();
    }

    // Update status in Supabase
    async function updateStatus(id) {
      const newStatus = document.getElementById('mStatusSelect').value;
      const msgEl = document.getElementById('statusMsg');
      msgEl.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
      msgEl.style.color = '#6b7280';

      const client = await waitSB();
      const { error } = await client
        .from('vfc_submissions')
        .update({ status: newStatus })
        .eq('id', id);

      if (error) {
        msgEl.textContent = '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message;
        msgEl.style.color = '#ef4444';
        return;
      }

      // Update local data
      const item = allData.find(d => String(d.id) === String(id));
      if (item) item.status = newStatus;

      msgEl.textContent = '‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢';
      msgEl.style.color = '#22c55e';
      updateStats();
      applyFilters();
      renderDashboard();
      setTimeout(() => { msgEl.textContent = ''; }, 3000);
    }

    // Save admin reply to Supabase
    async function saveReply(id) {
      const text = document.getElementById('mReplyText').value.trim();
      const msgEl = document.getElementById('replyMsg');
      msgEl.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
      msgEl.style.color = '#6b7280';

      const client = await waitSB();
      const { error } = await client
        .from('vfc_submissions')
        .update({ admin_response: text })
        .eq('id', id);

      if (error) {
        msgEl.textContent = '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message;
        msgEl.style.color = '#ef4444';
        return;
      }

      // Update local data
      const item = allData.find(d => String(d.id) === String(id));
      if (item) item.admin_response = text;

      msgEl.textContent = '‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢';
      msgEl.style.color = '#22c55e';
      setTimeout(() => { msgEl.textContent = ''; }, 3000);
    }

    function updateModalActions(id) {
      // Refresh modal buttons after toggle pin
      const pinned = isPinned(id);
      const btnEl = document.querySelector('#mActions .m-act-btn');
      if (btnEl) {
        btnEl.className = `m-act-btn ${pinned ? 'active' : ''}`;
        btnEl.innerHTML = `
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/></svg>
          ${pinned ? '‡πÄ‡∏•‡∏¥‡∏Å‡∏õ‡∏±‡∏Å‡∏°‡∏∏‡∏î' : '‡∏õ‡∏±‡∏Å‡∏°‡∏∏‡∏î'}
        `;
      }
    }

    function closeModal() {
      document.getElementById('detailModal').classList.remove('open');
    }

    // Keyboard
    document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

    // Refresh
    function refreshData() {
      document.getElementById('tBody').innerHTML = '<tr class="msg-row"><td colspan="11">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>';
      fetchData();
    }

    // Notification
    function updateNotifDot() {
      const unreadCount = allData.filter(d => !isRead(d.id)).length;
      const dot = document.getElementById('notifDot');
      if (dot) dot.style.display = unreadCount > 0 ? 'block' : 'none';
    }
    function toggleNotifPanel() {
      const unreadCount = allData.filter(d => !isRead(d.id)).length;
      if (unreadCount > 0) {
        alert('‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ ' + unreadCount + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡πà‡∏≤‡∏ô');
      } else {
        alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà');
      }
    }

    // Init
    document.addEventListener('DOMContentLoaded', async () => {
      await fetchData();
      updateNotifDot();
    });
  </script>
</body>
</html>
