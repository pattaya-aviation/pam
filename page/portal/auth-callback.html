<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>กำลังเข้าสู่ระบบ... - PAM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="../../function/shared/js/supabase-config.js"></script>
    <style>
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .spinner {
            animation: spin 0.8s linear infinite;
        }
    </style>
</head>

<body class="bg-white min-h-screen flex items-center justify-center">

    <div class="text-center">
        <svg class="spinner w-10 h-10 text-blue-500 mx-auto mb-4" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
        </svg>
        <p id="statusText" class="text-gray-600 font-medium">กำลังตรวจสอบ...</p>
    </div>

    <script>
        (function () {
            const ALLOWED_DOMAIN = '@pattayaaviation.com';
            const HOME_URL = '../../page/home/main/pam.html';
            const PORTAL_URL = '../../page/portal/index.html';
            const PENDING_URL = '../../page/portal/pending.html';
            const STATUS_EL = document.getElementById('statusText');

            function setStatus(msg) { STATUS_EL.textContent = msg; }

            // ── สร้าง client ใหม่ใน callback page เพื่อ detect session จาก URL ──
            // window.supabaseClient ถูกสร้างใน supabase-config.js ก่อนหน้า
            // แต่ PKCE code exchange เป็น async จึง listen ผ่าน onAuthStateChange แทน
            const db = window.supabaseClient;

            if (!db) {
                setStatus('ไม่สามารถเชื่อมต่อฐานข้อมูลได้');
                setTimeout(() => { window.location.href = HOME_URL; }, 2000);
                return;
            }

            let handled = false;

            // onAuthStateChange จะยิงเมื่อ PKCE code exchange เสร็จ
            const { data: { subscription } } = db.auth.onAuthStateChange(async (event, session) => {
                if (handled) return;
                // รอ SIGNED_IN หรือ INITIAL_SESSION ที่มี session จริง
                if ((event === 'SIGNED_IN' || event === 'INITIAL_SESSION') && session) {
                    handled = true;
                    subscription.unsubscribe();
                    await processSession(session);
                }
                // ถ้า INITIAL_SESSION แต่ session = null → ไม่มี session
                if (event === 'INITIAL_SESSION' && !session) {
                    handled = true;
                    subscription.unsubscribe();
                    setStatus('ไม่พบ session กรุณาลองใหม่');
                    setTimeout(() => { window.location.href = HOME_URL; }, 2000);
                }
            });

            // Timeout fallback ถ้า onAuthStateChange ไม่ยิงภายใน 10 วินาที
            setTimeout(() => {
                if (!handled) {
                    handled = true;
                    subscription.unsubscribe();
                    setStatus('หมดเวลา กรุณาลองใหม่');
                    setTimeout(() => { window.location.href = HOME_URL; }, 2000);
                }
            }, 10000);

            async function processSession(session) {
                const user = session.user;
                setStatus('ตรวจสอบสิทธิ์...');

                // บันทึก sessionStorage
                sessionStorage.setItem('user', JSON.stringify({
                    name: user.user_metadata?.full_name || user.email,
                    email: user.email,
                    id: user.id
                }));

                // ── Domain check ──────────────────────────────────────────
                if (!user.email?.endsWith(ALLOWED_DOMAIN)) {
                    await db.from('portal_users').upsert({
                        email: user.email,
                        name: user.user_metadata?.full_name || user.email,
                        ms_id: user.user_metadata?.provider_id || '',
                        status: 'rejected',
                        last_login: new Date().toISOString()
                    }, { onConflict: 'email' });

                    await db.auth.signOut();
                    sessionStorage.removeItem('user');
                    setStatus('อีเมลนี้ไม่ได้รับอนุญาตให้เข้าใช้ระบบ');
                    setTimeout(() => { window.location.href = HOME_URL; }, 2500);
                    return;
                }

                setStatus('บันทึกข้อมูล...');

                // ── ตรวจสอบ record เดิม ───────────────────────────────────
                const { data: existing, error: selErr } = await db
                    .from('portal_users')
                    .select('status')
                    .eq('email', user.email)
                    .maybeSingle();

                console.log('[auth-callback] select:', existing, selErr);

                if (!existing) {
                    // ครั้งแรก → insert pending
                    const { error: insErr } = await db.from('portal_users').insert({
                        email: user.email,
                        name: user.user_metadata?.full_name || user.email,
                        ms_id: user.user_metadata?.provider_id || '',
                        status: 'pending',
                        last_login: new Date().toISOString()
                    });
                    console.log('[auth-callback] insert err:', insErr);
                } else {
                    // login ซ้ำ → update last_login เท่านั้น
                    const { error: updErr } = await db.from('portal_users')
                        .update({ last_login: new Date().toISOString() })
                        .eq('email', user.email);
                    console.log('[auth-callback] update err:', updErr);
                }

                const status = existing?.status || 'pending';
                setStatus('กำลังนำทาง...');

                if (status === 'approved') {
                    window.location.href = PORTAL_URL;
                } else {
                    window.location.href = PENDING_URL;
                }
            }
        })();
    </script>

</body>

</html>