<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ตั้งค่าระบบ - PA System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../../../function/shared/css/fonts.css">
    <link rel="stylesheet" href="../../../function/portal/css/admin-base.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="../../../function/shared/js/supabase-config.js"></script>
    <script src="../../../function/portal/components/admin-nav.js"></script>
    <style>
        .admin-content {
            margin-left: 80px;
            padding: 24px 32px;
        }

        @media (max-width: 1023px) {
            .admin-content {
                margin-left: 0;
                padding: 20px 16px 24px;
            }
        }

        .tab-bar {
            display: flex;
            align-items: center;
            gap: 0;
            border-bottom: 2px solid #e5e7eb;
            width: 100%;
            margin-bottom: 20px;
        }

        .tab-btn {
            padding: 10px 20px;
            border: none;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            font-size: 0.8125rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            background: transparent;
            color: #6b7280;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .tab-btn:hover {
            color: #111827;
        }

        .tab-btn.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
            font-weight: 600;
        }

        .settings-card {
            background: white;
            border-radius: 14px;
            border: 1px solid #f3f4f6;
            padding: 24px;
            margin-bottom: 16px;
        }

        .settings-card h3 {
            font-size: 0.9375rem;
            font-weight: 700;
            color: #111827;
            margin-bottom: 4px;
        }

        .settings-card p {
            font-size: 0.75rem;
            color: #9ca3af;
            margin-bottom: 16px;
        }

        .user-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        .user-table th {
            padding: 10px 14px;
            font-size: 0.6875rem;
            font-weight: 700;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            text-align: left;
            border-bottom: 2px solid #e5e7eb;
            white-space: nowrap;
            background: white;
        }

        .user-table td {
            padding: 10px 14px;
            font-size: 0.8125rem;
            color: #374151;
            border-bottom: 1px solid #f3f4f6;
            vertical-align: middle;
        }

        .user-table tbody tr:hover {
            background: #f8fafc;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #e0e7ff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 700;
            color: #3b82f6;
        }

        .theme-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 12px;
        }

        .theme-option {
            border-radius: 12px;
            padding: 20px 16px;
            cursor: pointer;
            border: 2px solid #e5e7eb;
            transition: all 0.2s;
            text-align: center;
        }

        .theme-option:hover {
            border-color: #93c5fd;
        }

        .theme-option.selected {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
        }

        .theme-preview {
            width: 100%;
            height: 60px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .theme-label {
            font-size: 0.8125rem;
            font-weight: 600;
        }

        .theme-sub {
            font-size: 0.6875rem;
            color: #9ca3af;
            margin-top: 2px;
        }

        /* ── Permission Modal ── */
        .perm-overlay {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.45);
            backdrop-filter: blur(4px);
            align-items: center;
            justify-content: center;
        }

        .perm-overlay.open {
            display: flex;
        }

        .perm-modal {
            background: white;
            border-radius: 20px;
            width: min(640px, 95vw);
            max-height: 85vh;
            overflow-y: auto;
            padding: 28px 28px 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .perm-modal-title {
            font-size: 1.0625rem;
            font-weight: 700;
            color: #111827;
            margin-bottom: 4px;
        }

        .perm-modal-sub {
            font-size: 0.8125rem;
            color: #6b7280;
            margin-bottom: 20px;
        }

        .perm-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: #f3f4f6;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            color: #6b7280;
            transition: background 0.15s;
        }

        .perm-close:hover {
            background: #e5e7eb;
        }

        .perm-page-block {
            border: 1.5px solid #e5e7eb;
            border-radius: 14px;
            margin-bottom: 12px;
            overflow: hidden;
        }

        .perm-page-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            background: #f8fafc;
            cursor: pointer;
            user-select: none;
        }

        .perm-page-header:hover {
            background: #f1f5f9;
        }

        .perm-page-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 1.1rem;
        }

        .perm-page-label {
            font-weight: 600;
            font-size: 0.875rem;
            color: #111827;
            flex: 1;
        }

        .perm-page-toggle {
            position: relative;
            width: 40px;
            height: 22px;
            flex-shrink: 0;
        }

        .perm-page-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .perm-slider {
            position: absolute;
            inset: 0;
            background: #d1d5db;
            border-radius: 999px;
            transition: 0.2s;
            cursor: pointer;
        }

        .perm-slider:before {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            left: 3px;
            top: 3px;
            background: white;
            border-radius: 50%;
            transition: 0.2s;
        }

        input:checked+.perm-slider {
            background: #3b82f6;
        }

        input:checked+.perm-slider:before {
            transform: translateX(18px);
        }

        .perm-tabs-area {
            padding: 12px 16px 14px;
            border-top: 1px solid #f3f4f6;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .perm-tab-chip {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 5px 12px;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 500;
            border: 1.5px solid #e5e7eb;
            background: white;
            cursor: pointer;
            color: #6b7280;
            transition: all 0.15s;
            user-select: none;
        }

        .perm-tab-chip.checked {
            background: #eff6ff;
            border-color: #3b82f6;
            color: #2563eb;
        }

        .perm-tab-chip input {
            display: none;
        }

        .perm-save-btn {
            width: 100%;
            margin-top: 20px;
            padding: 12px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 0.9375rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.15s;
        }

        .perm-save-btn:hover {
            background: #1d4ed8;
        }

        .perm-save-btn:disabled {
            background: #93c5fd;
            cursor: not-allowed;
        }

        .perm-msg {
            margin-top: 10px;
            text-align: center;
            font-size: 0.8125rem;
            font-weight: 500;
            min-height: 20px;
        }

        .btn-perm {
            padding: 4px 12px;
            background: #eff6ff;
            color: #2563eb;
            border: 1.5px solid #bfdbfe;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            transition: all 0.15s;
        }

        .btn-perm:hover {
            background: #dbeafe;
        }

        .btn-revoke {
            padding: 4px 10px;
            background: #fee2e2;
            color: #dc2626;
            border: none;
            border-radius: 999px;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.15s;
        }

        .btn-revoke:hover {
            background: #fecaca;
        }

        .btn-approve {
            padding: 4px 10px;
            background: #dcfce7;
            color: #15803d;
            border: none;
            border-radius: 999px;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
        }

        /* ── Toast Notification ── */
        #toastContainer {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }

        .toast {
            background: white;
            border-radius: 14px;
            padding: 14px 18px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15), 0 0 0 1.5px #e5e7eb;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            min-width: 300px;
            max-width: 380px;
            pointer-events: all;
            animation: toast-in 0.35s cubic-bezier(0.34, 1.56, 0.64, 1) both;
            cursor: pointer;
        }

        .toast.toast-out {
            animation: toast-out 0.3s ease forwards;
        }

        @keyframes toast-in {
            from {
                opacity: 0;
                transform: translateX(60px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
        }

        @keyframes toast-out {
            from {
                opacity: 1;
                transform: translateX(0);
            }

            to {
                opacity: 0;
                transform: translateX(40px);
            }
        }

        .toast-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 1.1rem;
        }

        .toast-body {
            flex: 1;
        }

        .toast-title {
            font-size: 0.8125rem;
            font-weight: 700;
            color: #111827;
            margin-bottom: 2px;
        }

        .toast-sub {
            font-size: 0.75rem;
            color: #6b7280;
            line-height: 1.4;
        }

        .toast-action {
            margin-top: 8px;
            padding: 4px 12px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
        }

        .toast-close {
            flex-shrink: 0;
            background: none;
            border: none;
            cursor: pointer;
            color: #9ca3af;
            font-size: 1rem;
            line-height: 1;
            padding: 0;
            margin-top: -2px;
        }

        /* ── Add User Modal ── */
        .add-user-overlay {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 2000;
            background: rgba(0, 0, 0, 0.45);
            backdrop-filter: blur(4px);
            align-items: center;
            justify-content: center;
        }

        .add-user-overlay.open {
            display: flex;
        }

        .add-user-modal {
            background: white;
            border-radius: 20px;
            width: min(420px, 95vw);
            padding: 28px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .add-user-modal h3 {
            font-size: 1rem;
            font-weight: 700;
            color: #111827;
            margin-bottom: 4px;
        }

        .add-user-modal p {
            font-size: 0.8rem;
            color: #6b7280;
            margin-bottom: 20px;
        }

        .add-user-field {
            margin-bottom: 14px;
        }

        .add-user-field label {
            display: block;
            font-size: 0.75rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 6px;
        }

        .add-user-field input {
            width: 100%;
            padding: 9px 12px;
            border: 1.5px solid #e5e7eb;
            border-radius: 10px;
            font-size: 0.875rem;
            outline: none;
            transition: border-color 0.15s;
            box-sizing: border-box;
        }

        .add-user-field input:focus {
            border-color: #3b82f6;
        }

        .add-user-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-add-confirm {
            flex: 1;
            padding: 10px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.15s;
        }

        .btn-add-confirm:hover {
            background: #1d4ed8;
        }

        .btn-add-confirm:disabled {
            background: #93c5fd;
            cursor: not-allowed;
        }

        .btn-add-cancel {
            flex: 1;
            padding: 10px;
            background: #f3f4f6;
            color: #374151;
            border: none;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
        }

        .add-user-msg {
            margin-top: 10px;
            text-align: center;
            font-size: 0.8rem;
            font-weight: 500;
            min-height: 18px;
        }
    </style>
</head>

<body class="bg-white min-h-screen">
    <div id="adminNavContainer" data-admin-nav="settings"></div>

    <div class="admin-content">
        <div class="mb-4">
            <h1 class="text-xl font-bold text-gray-900">ตั้งค่าระบบ</h1>
            <p class="text-sm text-gray-500 mt-0.5">จัดการผู้ใช้ สิทธิ์การเข้าถึง และธีม</p>
        </div>

        <div class="tab-bar" style="margin-bottom:16px">
            <button class="tab-btn active" id="tabApproval" onclick="switchTab('approval')">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                อนุมัติ
                <span id="pendingBadge"
                    class="hidden ml-1 px-1.5 py-0.5 text-xs font-bold bg-red-500 text-white rounded-full"></span>
            </button>
            <button class="tab-btn" id="tabUsers" onclick="switchTab('users')">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                </svg>
                ผู้ใช้ทั้งหมด
            </button>
            <button class="tab-btn" id="tabTheme" onclick="switchTab('theme')">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" />
                </svg>
                ธีม
            </button>
            <button class="tab-btn" id="tabGeneral" onclick="switchTab('general')">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
                </svg>
                ทั่วไป
            </button>
        </div>

        <!-- Tab: Approval -->
        <div id="contentApproval" class="tab-content">
            <div class="settings-card">
                <div
                    style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:16px;gap:12px;flex-wrap:wrap">
                    <div>
                        <h3 style="margin-bottom:3px">คำขออนุมัติเข้าใช้งาน</h3>
                        <p style="margin-bottom:0">ผู้ใช้ที่ login ผ่าน Microsoft และรอให้ผู้ดูแลระบบอนุมัติ</p>
                    </div>
                    <div style="display:flex;gap:8px;flex-shrink:0">
                        <button onclick="loadApprovals()"
                            style="padding:6px 14px;background:#f3f4f6;color:#374151;border:none;border-radius:8px;font-size:0.8rem;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:5px"
                            title="โหลดใหม่">
                            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                            รีเฟรช
                        </button>
                        <button onclick="openAddUserModal()"
                            style="padding:6px 14px;background:#2563eb;color:white;border:none;border-radius:8px;font-size:0.8rem;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:5px"
                            title="เพิ่มผู้ใช้ด้วยมือ">
                            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 4v16m8-8H4" />
                            </svg>
                            เพิ่มผู้ใช้
                        </button>
                    </div>
                </div>
                <div style="overflow-x:auto">
                    <table class="user-table">
                        <thead>
                            <tr>
                                <th style="width:40px"></th>
                                <th>ชื่อ</th>
                                <th>อีเมล</th>
                                <th>ขอเข้าเมื่อ</th>
                                <th>สถานะ</th>
                                <th style="width:180px">จัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="approvalTableBody">
                            <tr>
                                <td colspan="6" style="text-align:center;color:#9ca3af;padding:40px">กำลังโหลด...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab: Users -->
        <div id="contentUsers" class="tab-content hidden">
            <div class="settings-card">
                <h3>รายชื่อผู้ใช้งานทั้งหมด</h3>
                <p>จัดการสิทธิ์การเข้าถึงหน้าและแท็บของผู้ใช้แต่ละคน</p>
                <div style="overflow-x:auto">
                    <table class="user-table">
                        <thead>
                            <tr>
                                <th style="width:40px"></th>
                                <th>ชื่อ</th>
                                <th>อีเมล</th>
                                <th>เข้าใช้ล่าสุด</th>
                                <th>สถานะ</th>
                                <th style="width:220px">จัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="userTableBody">
                            <tr>
                                <td colspan="6" style="text-align:center;color:#9ca3af;padding:40px">
                                    กำลังโหลดข้อมูลผู้ใช้...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab: Theme -->
        <div id="contentTheme" class="tab-content hidden">
            <div class="settings-card">
                <h3>ธีมการแสดงผล</h3>
                <p>เลือกธีมสำหรับ Admin Portal ทั้งระบบ</p>
                <div class="theme-grid">
                    <div class="theme-option selected" onclick="setTheme('light', this)">
                        <div class="theme-preview" style="background:#fff;border:1px solid #e5e7eb"><span
                                style="color:#111827">Aa</span></div>
                        <div class="theme-label">Light</div>
                        <div class="theme-sub">สว่าง — ค่าเริ่มต้น</div>
                    </div>
                    <div class="theme-option" onclick="setTheme('dark-grey', this)">
                        <div class="theme-preview" style="background:#1e1e1e"><span style="color:#fff">Aa</span></div>
                        <div class="theme-label">Dark Grey</div>
                        <div class="theme-sub">เทาเข้ม — ตัวอักษรขาว</div>
                    </div>
                    <div class="theme-option" onclick="setTheme('dark-navy', this)">
                        <div class="theme-preview" style="background:#0f172a"><span style="color:#fff">Aa</span></div>
                        <div class="theme-label">Navy</div>
                        <div class="theme-sub">กรมท่า — ตัวอักษรขาว</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: General -->
        <div id="contentGeneral" class="tab-content hidden">
            <div class="settings-card">
                <h3>ตั้งค่าทั่วไป</h3>
                <p>การตั้งค่าทั่วไปของระบบ</p>
                <div style="text-align:center;padding:40px;color:#9ca3af">
                    <svg style="width:48px;height:48px;margin:0 auto 12px;display:block;color:#d1d5db" fill="none"
                        stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                            d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
                    </svg>
                    <p>Coming soon</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ══ Toast Container ══ -->
    <div id="toastContainer"></div>

    <!-- ══ Add User Modal ══ -->
    <div class="add-user-overlay" id="addUserOverlay" onclick="if(event.target===this)closeAddUserModal()">
        <div class="add-user-modal">
            <button class="perm-close" onclick="closeAddUserModal()">✕</button>
            <h3>เพิ่มผู้ใช้ด้วยมือ</h3>
            <p>สำหรับกรณีที่ระบบ auto-insert ไม่สำเร็จ — กรอกข้อมูลผู้ใช้เพื่ออนุมัติทันที</p>
            <div class="add-user-field">
                <label>ชื่อ-นามสกุล</label>
                <input type="text" id="addUserName" placeholder="เช่น All HD-S">
            </div>
            <div class="add-user-field">
                <label>อีเมล <span style="color:#ef4444">*</span></label>
                <input type="email" id="addUserEmail" placeholder="เช่น hr.strategic@pattayaaviation.com">
            </div>
            <div class="add-user-field">
                <label>สถานะเริ่มต้น</label>
                <select id="addUserStatus"
                    style="width:100%;padding:9px 12px;border:1.5px solid #e5e7eb;border-radius:10px;font-size:0.875rem;outline:none;background:white;box-sizing:border-box">
                    <option value="approved">✅ อนุมัติทันที (approved)</option>
                    <option value="pending">⏳ รอการอนุมัติ (pending)</option>
                </select>
            </div>
            <div class="add-user-actions">
                <button class="btn-add-cancel" onclick="closeAddUserModal()">ยกเลิก</button>
                <button class="btn-add-confirm" id="addUserConfirmBtn" onclick="confirmAddUser()">✅ เพิ่มผู้ใช้</button>
            </div>
            <div class="add-user-msg" id="addUserMsg"></div>
        </div>
    </div>

    <!-- ══ Permission Modal ══ -->
    <div class="perm-overlay" id="permOverlay" onclick="if(event.target===this)closePermModal()">
        <div class="perm-modal">
            <button class="perm-close" onclick="closePermModal()">✕</button>
            <div class="perm-modal-title" id="permModalTitle">ตั้งค่าสิทธิ์</div>
            <div class="perm-modal-sub" id="permModalSub"></div>
            <div id="permPageList"></div>
            <button class="perm-save-btn" id="permSaveBtn" onclick="savePermissions()">💾 บันทึกสิทธิ์</button>
            <div class="perm-msg" id="permMsg"></div>
        </div>
    </div>

    <script>
        const user = sessionStorage.getItem('user');
        if (!user) window.location.href = (typeof adminNavBasePath !== 'undefined' ? adminNavBasePath : '../') + '../home/main/pam.html';

        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.getElementById('tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1))?.classList.add('active');
            document.getElementById('content' + tabName.charAt(0).toUpperCase() + tabName.slice(1))?.classList.remove('hidden');
        }

        const db = window.supabaseClient;
        const adminUser = JSON.parse(sessionStorage.getItem('user') || '{}');

        // ── Page / Tab config ──
        const PAGE_CONFIG = [
            {
                id: 'vfc', label: 'Voice for Change', icon: '🎤', iconBg: '#eff6ff',
                tabs: [
                    { id: 'inbox', label: 'หน้าแรก' }, { id: 'cards', label: 'การ์ด' },
                    { id: 'board', label: 'กระดาน' }, { id: 'table', label: 'รายการ' },
                    { id: 'calendar', label: 'ปฏิทิน' }, { id: 'trash', label: 'ถังขยะ' },
                    { id: 'settings', label: 'ตั้งค่า' },
                ]
            },
            {
                id: 'tax', label: 'ภาษี', icon: '🧾', iconBg: '#f0fdf4',
                tabs: [
                    { id: 'overview', label: 'ภาพรวม' }, { id: 'calculator', label: 'คำนวณภาษี' },
                    { id: 'ly01', label: 'ลดหย่อน (ล.ย.01)' },
                ]
            },
            {
                id: 'settings', label: 'ตั้งค่าระบบ', icon: '⚙️', iconBg: '#fafaf9',
                tabs: [
                    { id: 'approval', label: 'อนุมัติ' }, { id: 'users', label: 'ผู้ใช้ทั้งหมด' },
                    { id: 'theme', label: 'ธีม' }, { id: 'general', label: 'ทั่วไป' },
                ]
            },
        ];

        let permTarget = null;

        function openPermModal(email, name, existingPerms) {
            permTarget = { email, name };
            document.getElementById('permModalTitle').textContent = `สิทธิ์ของ ${name || email}`;
            document.getElementById('permModalSub').textContent = email;
            document.getElementById('permMsg').textContent = '';

            const list = document.getElementById('permPageList');
            list.innerHTML = '';

            PAGE_CONFIG.forEach(page => {
                const pagePerms = existingPerms?.[page.id] || { access: true, tabs: {} };
                const hasAccess = pagePerms.access !== false;

                const block = document.createElement('div');
                block.className = 'perm-page-block';

                const header = document.createElement('div');
                header.className = 'perm-page-header';
                header.onclick = () => {
                    const chk = document.getElementById(`pageChk_${page.id}`);
                    chk.checked = !chk.checked;
                    updatePageBlock(page.id);
                };
                header.innerHTML = `
                    <div class="perm-page-icon" style="background:${page.iconBg}">${page.icon}</div>
                    <span class="perm-page-label">${page.label}</span>
                    <label class="perm-page-toggle" onclick="event.stopPropagation()">
                        <input type="checkbox" id="pageChk_${page.id}" ${hasAccess ? 'checked' : ''}
                            onchange="updatePageBlock('${page.id}')">
                        <span class="perm-slider"></span>
                    </label>`;
                block.appendChild(header);

                const tabsArea = document.createElement('div');
                tabsArea.className = 'perm-tabs-area';
                tabsArea.id = `tabsArea_${page.id}`;
                if (!hasAccess) tabsArea.style.display = 'none';

                page.tabs.forEach(tab => {
                    const tabOk = (pagePerms.tabs?.[tab.id] !== false);
                    const chip = document.createElement('label');
                    chip.className = 'perm-tab-chip' + (tabOk ? ' checked' : '');
                    chip.innerHTML = `<input type="checkbox" id="tabChk_${page.id}_${tab.id}" ${tabOk ? 'checked' : ''}
                        onchange="this.closest('.perm-tab-chip').classList.toggle('checked', this.checked)">
                        ${tab.label}`;
                    tabsArea.appendChild(chip);
                });

                block.appendChild(tabsArea);
                list.appendChild(block);
            });

            document.getElementById('permOverlay').classList.add('open');
        }

        function updatePageBlock(pageId) {
            const chk = document.getElementById(`pageChk_${pageId}`);
            document.getElementById(`tabsArea_${pageId}`).style.display = chk.checked ? '' : 'none';
        }

        function closePermModal() {
            document.getElementById('permOverlay').classList.remove('open');
            permTarget = null;
        }

        async function savePermissions() {
            if (!permTarget || !db) return;
            const btn = document.getElementById('permSaveBtn');
            const msg = document.getElementById('permMsg');
            btn.disabled = true;
            btn.textContent = 'กำลังบันทึก...';

            const perms = {};
            PAGE_CONFIG.forEach(page => {
                const access = !!document.getElementById(`pageChk_${page.id}`)?.checked;
                const tabs = {};
                page.tabs.forEach(tab => {
                    tabs[tab.id] = !!document.getElementById(`tabChk_${page.id}_${tab.id}`)?.checked;
                });
                perms[page.id] = { access, tabs };
            });

            const { error } = await db
                .from('portal_users')
                .update({ permissions: perms })
                .eq('email', permTarget.email);

            btn.disabled = false;
            btn.textContent = '💾 บันทึกสิทธิ์';

            if (error) {
                msg.style.color = '#ef4444';
                msg.textContent = '❌ ' + error.message;
                // If column doesn't exist yet, show helpful message
                if (error.message.includes('permissions')) {
                    msg.textContent = '❌ กรุณารัน SQL migration ใน Supabase ก่อน (supabase/add_permissions_column.sql)';
                }
            } else {
                msg.style.color = '#22c55e';
                msg.textContent = '✅ บันทึกสิทธิ์เรียบร้อยแล้ว';
                setTimeout(() => { closePermModal(); loadUsers(); }, 1200);
            }
        }

        function statusBadge(status) {
            const map = { pending: ['#fef3c7', '#92400e', 'รอการอนุมัติ'], approved: ['#dcfce7', '#14532d', 'อนุมัติแล้ว'], rejected: ['#fee2e2', '#7f1d1d', 'ถูกปฏิเสธ'] };
            const [bg, color, label] = map[status] || ['#f3f4f6', '#6b7280', status];
            return `<span style="background:${bg};color:${color};padding:3px 10px;border-radius:999px;font-size:0.6875rem;font-weight:600">${label}</span>`;
        }

        async function loadApprovals() {
            if (!db) return;
            const { data } = await db.from('portal_users').select('*').eq('status', 'pending').order('created_at', { ascending: true });
            const tbody = document.getElementById('approvalTableBody');
            const badge = document.getElementById('pendingBadge');
            if (data?.length > 0) { badge.textContent = data.length; badge.classList.remove('hidden'); } else badge.classList.add('hidden');
            if (!data?.length) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:#9ca3af;padding:40px"><svg style="width:40px;height:40px;margin:0 auto 8px;display:block;color:#d1d5db" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>ไม่มีรายการรอการอนุมัติ</td></tr>`;
                return;
            }
            tbody.innerHTML = data.map(u => {
                const initials = (u.name || u.email || '?').charAt(0).toUpperCase();
                const created = u.created_at ? new Date(u.created_at).toLocaleString('th-TH', { dateStyle: 'short', timeStyle: 'short' }) : '-';
                return `<tr>
                    <td><div class="user-avatar">${initials}</div></td>
                    <td style="font-weight:500">${u.name || '-'}</td>
                    <td style="font-size:0.75rem;color:#6b7280">${u.email || '-'}</td>
                    <td style="font-size:0.75rem;color:#9ca3af">${created}</td>
                    <td>${statusBadge(u.status)}</td>
                    <td><div style="display:flex;gap:6px">
                        <button class="btn-approve" onclick="setStatus('${u.email}','approved')">อนุมัติ</button>
                        <button style="padding:5px 12px;background:#f3f4f6;color:#6b7280;border:none;border-radius:999px;font-size:0.75rem;font-weight:600;cursor:pointer" onclick="setStatus('${u.email}','rejected')">ปฏิเสธ</button>
                    </div></td>
                </tr>`;
            }).join('');
        }

        async function loadUsers() {
            if (!db) { showMockUsers(); return; }
            const { data, error } = await db.from('portal_users').select('*').order('last_login', { ascending: false });
            if (error || !data?.length) { showMockUsers(); return; }
            renderUsers(data);
        }

        function showMockUsers() {
            const u = adminUser;
            renderUsers([{ name: u.name || 'Admin', email: u.email || 'admin@pa.com', status: 'approved', last_login: new Date().toISOString(), permissions: null }]);
        }

        function renderUsers(users) {
            const tbody = document.getElementById('userTableBody');
            tbody.innerHTML = users.map(u => {
                const initials = (u.name || u.email || '?').charAt(0).toUpperCase();
                const lastLogin = u.last_login ? new Date(u.last_login).toLocaleString('th-TH', { dateStyle: 'short', timeStyle: 'short' }) : '-';
                const permsJson = JSON.stringify(u.permissions || null);
                return `<tr>
                    <td><div class="user-avatar">${initials}</div></td>
                    <td style="font-weight:500">${u.name || '-'}</td>
                    <td style="font-size:0.75rem;color:#6b7280">${u.email || '-'}</td>
                    <td style="font-size:0.75rem;color:#9ca3af">${lastLogin}</td>
                    <td>${statusBadge(u.status || 'pending')}</td>
                    <td>
                        <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
                            <button class="btn-perm" onclick='openPermModal(${JSON.stringify(u.email)},${JSON.stringify(u.name || "")},${permsJson})'>
                                <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
                                สิทธิ์
                            </button>
                            ${u.status === 'approved'
                        ? `<button class="btn-revoke" onclick="setStatus('${u.email}','rejected')">เพิกถอน</button>`
                        : `<button class="btn-approve" onclick="setStatus('${u.email}','approved')">อนุมัติ</button>`
                    }
                        </div>
                    </td>
                </tr>`;
            }).join('');
        }

        async function setStatus(email, status) {
            if (!db) return;
            const { error } = await db.from('portal_users')
                .update({ status, approved_by: adminUser.email || 'admin', approved_at: new Date().toISOString() })
                .eq('email', email);
            if (!error) { loadApprovals(); loadUsers(); }
            else alert('เกิดข้อผิดพลาด: ' + error.message);
        }

        // ── Add User Modal ──────────────────────────────────────
        function openAddUserModal() {
            document.getElementById('addUserName').value = '';
            document.getElementById('addUserEmail').value = '';
            document.getElementById('addUserStatus').value = 'approved';
            document.getElementById('addUserMsg').textContent = '';
            document.getElementById('addUserConfirmBtn').disabled = false;
            document.getElementById('addUserOverlay').classList.add('open');
            setTimeout(() => document.getElementById('addUserName').focus(), 100);
        }

        function closeAddUserModal() {
            document.getElementById('addUserOverlay').classList.remove('open');
        }

        async function confirmAddUser() {
            if (!db) return;
            const name = document.getElementById('addUserName').value.trim();
            const email = document.getElementById('addUserEmail').value.trim().toLowerCase();
            const status = document.getElementById('addUserStatus').value;
            const msg = document.getElementById('addUserMsg');
            const btn = document.getElementById('addUserConfirmBtn');

            if (!email) {
                msg.style.color = '#ef4444';
                msg.textContent = '❌ กรุณากรอกอีเมล';
                return;
            }

            btn.disabled = true;
            btn.textContent = 'กำลังบันทึก...';
            msg.textContent = '';

            // upsert: insert ถ้ายังไม่มี, update status ถ้ามีอยู่แล้ว
            const { error } = await db.from('portal_users').upsert({
                email,
                name: name || email,
                status,
                approved_by: status === 'approved' ? (adminUser.email || 'admin') : null,
                approved_at: status === 'approved' ? new Date().toISOString() : null,
                last_login: new Date().toISOString()
            }, { onConflict: 'email' });

            btn.disabled = false;
            btn.textContent = '✅ เพิ่มผู้ใช้';

            if (error) {
                msg.style.color = '#ef4444';
                msg.textContent = '❌ ' + error.message;
            } else {
                msg.style.color = '#22c55e';
                msg.textContent = status === 'approved'
                    ? `✅ อนุมัติ ${email} เรียบร้อยแล้ว`
                    : `✅ เพิ่ม ${email} เป็น pending แล้ว`;
                setTimeout(() => { closeAddUserModal(); loadApprovals(); loadUsers(); }, 1500);
            }
        }

        function setTheme(theme, el) {
            document.body.classList.remove('dark-grey', 'dark-navy');
            if (theme !== 'light') document.body.classList.add(theme);
            localStorage.setItem('admin-theme', theme);
            document.querySelectorAll('.theme-option').forEach(o => o.classList.remove('selected'));
            if (el) el.classList.add('selected');
        }

        function loadTheme() {
            const saved = localStorage.getItem('admin-theme');
            if (saved && saved !== 'light') {
                document.body.classList.add(saved);
                document.querySelectorAll('.theme-option').forEach(el => el.classList.remove('selected'));
                const opts = document.querySelectorAll('.theme-option');
                if (saved === 'dark-grey' && opts[1]) opts[1].classList.add('selected');
                if (saved === 'dark-navy' && opts[2]) opts[2].classList.add('selected');
            }
        }

        // ── Toast ───────────────────────────────────────────────
        function showToast({ icon = '🔔', iconBg = '#eff6ff', title, sub, actionLabel, onAction, duration = 7000 }) {
            const container = document.getElementById('toastContainer');
            const t = document.createElement('div');
            t.className = 'toast';
            t.innerHTML = `
                <div class="toast-icon" style="background:${iconBg}">${icon}</div>
                <div class="toast-body">
                    <div class="toast-title">${title}</div>
                    <div class="toast-sub">${sub}</div>
                    ${actionLabel ? `<button class="toast-action" id="toastActionBtn">${actionLabel}</button>` : ''}
                </div>
                <button class="toast-close" title="ปิด">✕</button>`;

            container.appendChild(t);

            const dismiss = () => {
                t.classList.add('toast-out');
                setTimeout(() => t.remove(), 300);
            };

            t.querySelector('.toast-close').onclick = dismiss;
            if (actionLabel && onAction) {
                t.querySelector('#toastActionBtn').onclick = () => { onAction(); dismiss(); };
            }

            const timer = setTimeout(dismiss, duration);
            t.addEventListener('mouseenter', () => clearTimeout(timer));
        }

        // ── Supabase Realtime ────────────────────────────────────
        function startRealtimeSubscription() {
            if (!db) return;
            db.channel('portal_users_changes')
                .on(
                    'postgres_changes',
                    { event: 'INSERT', schema: 'public', table: 'portal_users', filter: 'status=eq.pending' },
                    (payload) => {
                        const u = payload.new;
                        // Auto-refresh ตาราง + badge
                        loadApprovals();

                        // Toast แจ้งเตือน
                        showToast({
                            icon: '👤',
                            iconBg: '#fef3c7',
                            title: 'ร้องขอเข้าใช้งานใหม่!',
                            sub: `<strong>${u.name || u.email}</strong><br>${u.email}`,
                            actionLabel: 'อนุมัติเลย',
                            onAction: () => {
                                // Switch ไป tab อนุมัติและ highlight
                                switchTab('approval');
                                setStatus(u.email, 'approved');
                            },
                            duration: 12000
                        });

                        // Browser Notification (ถ้ายังไม่ได้ยิน)
                        if (Notification.permission === 'granted') {
                            new Notification('PA System — ร้องขอเข้าใช้งาน', {
                                body: `${u.name || u.email} (${u.email}) ขอเข้าใช้งานระบบ`,
                                icon: '/favicon.ico'
                            });
                        }
                    }
                )
                .on(
                    'postgres_changes',
                    { event: 'UPDATE', schema: 'public', table: 'portal_users' },
                    () => { loadApprovals(); loadUsers(); }
                )
                .subscribe((status) => {
                    console.log('[Realtime] portal_users:', status);
                });
        }

        // ขอสิทธิ์ Browser Notification
        function requestNotifPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadApprovals();
            loadUsers();
            loadTheme();
            startRealtimeSubscription();
            requestNotifPermission();
        });
    </script>
</body>

</html>